import"./qrcode-_3APf9r8.js";import{H as U,J as Ee}from"./firebase-vendor-BDhSju_T.js";import{o as De,s as Ie}from"./firebase-auth-V8RQ8eEz.js";import"./firebase-app-CdRXrjY0.js";import{getDoc as be,doc as H,updateDoc as ae,deleteDoc as we}from"./firebase-firestore-DyzXcozE.js";import"./vendor-BdN5Q6dY.js";const K=document.getElementById("user-name"),Q=document.getElementById("user-avatar"),oe=document.getElementById("summary-branch"),le=document.getElementById("summary-location"),ce=document.getElementById("summary-itemName"),j=document.getElementById("summary-frequency"),R=document.getElementById("tasks-list"),de=document.getElementById("add-task-btn"),q=document.getElementById("add-task-modal-overlay"),ie=document.getElementById("close-add-task-modal-btn"),re=document.getElementById("cancel-add-task-btn"),A=document.getElementById("add-task-form"),L=document.getElementById("save-add-task-btn"),ee=document.getElementById("add-task-schedule-container"),M=document.getElementById("add-task-schedule-calendar"),te=document.getElementById("inspection-actions-btn"),P=document.getElementById("inspection-actions-menu"),me=document.getElementById("edit-maintenance-btn"),ue=document.getElementById("delete-maintenance-btn"),J=document.getElementById("edit-modal-overlay"),ye=document.getElementById("close-modal-btn"),fe=document.getElementById("cancel-edit-btn"),ne=document.getElementById("edit-maintenance-form"),O=document.getElementById("save-edit-btn"),pe=document.getElementById("edit-frequency"),$=document.getElementById("edit-schedule-container"),N=document.getElementById("edit-schedule-calendar");let w=null,l=null;De(Ee,async e=>{if(e)try{let n=e.email||"User";const t=await be(H(U,"users",e.uid));if(t.exists()){const a=t.data();n=a.fullName||a.name||e.email||"User"}if(K&&(K.textContent=n),Q){const a=n.trim().charAt(0).toUpperCase();Q.textContent=a||"U"}}catch(n){console.error("Error loading user data for header:",n);const t=e&&(e.displayName||e.email)||"User";if(K&&(K.textContent=t),Q){const a=t.trim().charAt(0).toUpperCase();Q.textContent=a||"U"}}});function Te(e){const n=e.toLowerCase();return n.includes("weekly")?"frequency-weekly":n.includes("monthly")?"frequency-monthly":n.includes("quarterly")?"frequency-quarterly":""}function W(e,n,t={}){n.innerHTML="";const a=new Date().getFullYear(),c=document.createElement("select");c.className="calendar-year-select";for(let f=a;f<=a+2;f++){const o=document.createElement("option");o.value=f,o.textContent=f,f===a&&(o.selected=!0),c.appendChild(o)}const s=document.createElement("div");s.className="calendar-year-selector";const i=document.createElement("label");i.textContent="Year: ",i.style.fontWeight="600",s.appendChild(i),s.appendChild(c),n.appendChild(s);const b=document.createElement("div");b.className="calendar-months",e==="Weekly"?["January","February","March","April","May","June","July","August","September","October","November","December"].forEach((o,d)=>{const E=document.createElement("div");E.className="calendar-month";const g=document.createElement("div");g.className="calendar-month-header",g.textContent=o,E.appendChild(g);const k=document.createElement("div");k.className="calendar-weeks";for(let v=1;v<=4;v++){const r=document.createElement("div");r.className="calendar-week";const m=document.createElement("div");m.className="calendar-week-label",m.textContent=`Week ${v}:`,r.appendChild(m);const p=document.createElement("input");p.type="date",p.className="calendar-date-input",p.dataset.month=d,p.dataset.week=v,p.dataset.key=`${d}-${v}`;const h=parseInt(c.value),u=new Date(h,d,1).getDay(),C=u===0?2:u===1?1:9-u,D=new Date(h,d,C+(v-1)*7);D.getMonth()===d&&(p.value=D.toISOString().split("T")[0]);const y=`${h}-${d}-${v}`;t[y]&&(p.value=t[y]),r.appendChild(p),k.appendChild(r)}E.appendChild(k),b.appendChild(E)}):e==="Monthly"?["January","February","March","April","May","June","July","August","September","October","November","December"].forEach((o,d)=>{const E=document.createElement("div");E.className="calendar-month";const g=document.createElement("div");g.className="calendar-month-header",g.textContent=o,E.appendChild(g);const k=document.createElement("input");k.type="date",k.className="calendar-date-input",k.dataset.month=d,k.dataset.key=`${d}`;const v=parseInt(c.value),r=new Date(v,d,1);k.value=r.toISOString().split("T")[0];const m=`${v}-${d}`;t[m]&&(k.value=t[m]),E.appendChild(k),b.appendChild(E)}):e==="Quarterly"&&[{name:"Q1",months:["January","February","March"],monthIndices:[0,1,2]},{name:"Q2",months:["April","May","June"],monthIndices:[3,4,5]},{name:"Q3",months:["July","August","September"],monthIndices:[6,7,8]},{name:"Q4",months:["October","November","December"],monthIndices:[9,10,11]}].forEach((o,d)=>{const E=document.createElement("div");E.className="calendar-quarter";const g=document.createElement("div");g.className="calendar-quarter-label",g.textContent=o.name,E.appendChild(g);const k=document.createElement("div");k.style.display="flex",k.style.alignItems="center",k.style.gap="0.5rem",k.style.marginBottom="0.5rem";const v=document.createElement("label");v.textContent="Select Month:",v.style.minWidth="100px",v.style.fontSize="0.85rem",v.style.fontWeight="600",k.appendChild(v);const r=document.createElement("select");r.className="calendar-month-select",r.dataset.quarter=d,r.dataset.key=`${d}`;const m=document.createElement("option");m.value="",m.textContent="Choose month...",r.appendChild(m),o.months.forEach((C,D)=>{const y=o.monthIndices[D],I=document.createElement("option");I.value=y,I.textContent=C,r.appendChild(I)});const p=parseInt(c.value);let h=null;for(let C=0;C<o.months.length;C++){const D=o.monthIndices[C],y=`${p}-${d}-${C}`;if(t[y]){h=D,r.value=D;break}}k.appendChild(r);const u=document.createElement("input");if(u.type="date",u.className="calendar-date-input",u.dataset.quarter=d,u.dataset.key=`${d}`,u.style.display=h!==null?"block":"none",u.style.marginTop="0.5rem",h!==null){for(let C=0;C<o.months.length;C++)if(o.monthIndices[C]===h){const y=`${p}-${d}-${C}`;if(t[y])u.value=t[y];else{const I=new Date(p,h,1);u.value=I.toISOString().split("T")[0]}break}}r.addEventListener("change",()=>{if(r.value){const C=parseInt(r.value);u.style.display="block";const D=new Date(p,C,1);u.value=D.toISOString().split("T")[0];for(let y=0;y<o.months.length;y++)if(o.monthIndices[y]===C){const I=`${p}-${d}-${y}`;t[I]&&(u.value=t[I]);break}}else u.style.display="none",u.value=""}),E.appendChild(k),E.appendChild(u),b.appendChild(E)}),n.appendChild(b),c.addEventListener("change",()=>{W(e,n,t)})}function se(e,n,t){const a={};return e.querySelectorAll(".calendar-date-input").forEach(s=>{if(s.value&&s.style.display!=="none"){const i=s.dataset.key;if(n==="Weekly"){const[b,f]=i.split("-");a[`${t}-${b}-${f}`]=s.value}else if(n==="Monthly"){const b=i;a[`${t}-${b}`]=s.value}else if(n==="Quarterly"){const b=parseInt(i),f=e.querySelector(`select[data-quarter="${b}"]`);if(f&&f.value){const o=parseInt(f.value),g=[{monthIndices:[0,1,2]},{monthIndices:[3,4,5]},{monthIndices:[6,7,8]},{monthIndices:[9,10,11]}][b].monthIndices.indexOf(o);g!==-1&&(a[`${t}-${b}-${g}`]=s.value)}}}}),a}async function z(){const n=new URLSearchParams(window.location.search).get("id");if(!n){alert("No maintenance item ID provided."),window.location.href="maintenance.html";return}w=n;try{const t=await be(H(U,"maintenance",n));if(!t.exists()){alert("Maintenance item not found."),window.location.href="maintenance.html";return}const a=t.data();if(l=a,oe&&(oe.textContent=a.branch||"Not set"),le&&(le.textContent=a.location||"Not set"),ce&&(ce.textContent=a.itemName||"Not set"),j){j.innerHTML="";const c=a.frequency||"Not set",s=Te(c);if(s){const i=document.createElement("span");i.className=`frequency-badge ${s}`,i.textContent=c,j.appendChild(i)}else j.textContent=c}if(R){R.innerHTML="";let c=a.inspectionTasks||[];if(typeof c=="string"?c=c.split(`
`).filter(s=>s.trim()):Array.isArray(c)||(c=[]),!c||c.length===0){const s=document.createElement("li");s.className="no-tasks",s.textContent="No inspection tasks found.",R.appendChild(s)}else c.forEach((s,i)=>{const b=document.createElement("li");b.className="task-item";const f=document.createElement("div");f.className="task-number",f.textContent=i+1,b.appendChild(f);const o=document.createElement("div");o.className="task-text",o.style.flex="1";const d=document.createElement("div");d.style.fontSize="1rem",d.style.fontWeight="600",d.style.marginBottom="0.5rem",d.textContent=s,o.appendChild(d);let g=(a.taskDates||[])[i]||"";const k=document.createElement("div");k.className="task-date";const v=document.createElement("div");if(v.className="task-date-info",g){const h=new Date(g),u=new Date;u.setHours(0,0,0,0);const C=new Date(h.getFullYear(),h.getMonth(),h.getDate());let D=Math.ceil((C-u)/(1e3*60*60*24)),y=h;const I=a.frequency||"Monthly";if(D<0){if(I==="Weekly")for(;y<=u;)y=new Date(y.getTime()+7*24*60*60*1e3);else if(I==="Monthly")for(;y<=u;)y=new Date(y.getFullYear(),y.getMonth()+1,y.getDate());else if(I==="Quarterly")for(;y<=u;)y=new Date(y.getFullYear(),y.getMonth()+3,y.getDate());const Ce=new Date(y.getFullYear(),y.getMonth(),y.getDate());D=Math.ceil((Ce-u)/(1e3*60*60*24))}const _=document.createElement("div");_.className="task-date-value",_.textContent=`Upcoming: ${y.toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"})}`,v.appendChild(_);const T=document.createElement("div");T.className="task-days-remaining",D===0?(T.textContent="Today",T.style.background="#fee2e2",T.style.color="#991b1b"):D===1?(T.textContent="Tomorrow",T.style.background="#fef3c7",T.style.color="#92400e"):(T.textContent=`${D} days remaining`,T.style.background="#dbeafe",T.style.color="#1e40af"),v.appendChild(T)}else{const h=document.createElement("div");h.className="task-date-label",h.textContent="No date scheduled",h.style.color="#9ca3af",v.appendChild(h)}k.appendChild(v);const r=document.createElement("div");r.style.display="flex",r.style.gap="0.5rem",r.style.alignItems="center";const m=document.createElement("button");m.type="button",m.className="task-date-edit-btn",m.textContent="Edit Calendar",m.style.cursor="pointer",m.addEventListener("click",()=>{const h=a.frequency||"Monthly",u=a.scheduleDates||{},C=a.scheduleYear||new Date().getFullYear();Me(i,s,g,h,u,C)}),r.appendChild(m);const p=document.createElement("a");p.href=`inspectionassets.html?maintenanceId=${encodeURIComponent(w)}&taskIndex=${i}`,p.className="task-date-edit-btn",p.textContent="View more",p.style.textDecoration="none",p.style.display="inline-block",r.appendChild(p),k.appendChild(r),o.appendChild(k),b.appendChild(o),R.appendChild(b)})}}catch(t){console.error("Error loading inspection tasks:",t),alert("Failed to load inspection tasks. Please try again."),window.location.href="maintenance.html"}}function Be(){if(console.log("openAddTaskModal called"),!q){console.error("Add Task modal overlay not found!");return}if(A&&A.reset(),l&&M&&ee){const e=l.frequency||"Monthly";console.log("Generating calendar for frequency:",e),ee.style.display="block",W(e,M)}else console.warn("Calendar elements not found:",{currentMaintenanceData:!!l,addTaskScheduleCalendar:!!M,addTaskScheduleContainer:!!ee});q.classList.add("open"),console.log("Modal opened")}function G(){q&&(q.classList.remove("open"),A&&A.reset(),M&&(M.innerHTML=""))}de?de.addEventListener("click",e=>{if(e.preventDefault(),e.stopPropagation(),console.log("Add Task button clicked"),!w){alert("Maintenance item not loaded. Please wait for the page to finish loading.");return}if(!l){alert("Maintenance data not loaded. Please wait for the page to finish loading.");return}console.log("Opening Add Task modal"),Be()}):console.error("Add Task button not found!");ie&&ie.addEventListener("click",G);re&&re.addEventListener("click",G);q&&q.addEventListener("click",e=>{e.target===q&&G()});A&&A.addEventListener("submit",async e=>{var n,t;if(e.preventDefault(),!w||!l){alert("Maintenance item not loaded.");return}if(L){L.disabled=!0,L.textContent="Adding...";try{const c=((n=new FormData(A).get("taskText"))==null?void 0:n.trim())||"";if(!c){alert("Please enter a task description."),L.disabled=!1,L.textContent="Add Task";return}let s=l.inspectionTasks||[];typeof s=="string"?s=s.split(`
`).filter(g=>g.trim()):Array.isArray(s)||(s=[]),s.push(c);const i=l.frequency||"Monthly",b=((t=M==null?void 0:M.querySelector(".calendar-year-select"))==null?void 0:t.value)||new Date().getFullYear(),f=se(M,i,parseInt(b)),o=Object.keys(f);if(o.length===0){alert("Please select a date for this task based on the frequency."),L.disabled=!1,L.textContent="Add Task";return}let d=f[o[0]]||"";const E=l.taskDates||[];E.push(d),await ae(H(U,"maintenance",w),{inspectionTasks:s,taskDates:E,updatedAt:new Date().toISOString()}),alert("Task added successfully!"),G(),await z()}catch(a){console.error("Error adding task:",a),alert("Failed to add task. Please try again.")}finally{L&&(L.disabled=!1,L.textContent="Add Task")}}});let V=null;const F=document.getElementById("task-date-modal-overlay"),he=document.getElementById("task-date-modal-title"),x=document.getElementById("task-date-modal-calendar"),ge=document.getElementById("close-task-date-modal-btn"),ke=document.getElementById("cancel-task-date-btn"),Y=document.getElementById("save-task-date-btn");function Le(e,n,t,a,c){const s={};return a&&a[e]&&a[e],!t||Object.keys(t).length===0||Object.keys(t).forEach(i=>{i.split("-")[0]==c&&(s[i]=t[i])}),s}function Me(e,n,t,a,c,s){if(V=e,he&&(he.textContent=`Edit Calendar: ${n}`),x){x.innerHTML="";const i=s||new Date().getFullYear(),b=(l==null?void 0:l.taskDates)||[],f=Le(e,a,c||{},b,i);W(a,x,f),setTimeout(()=>{if(s){const o=x.querySelector(".calendar-year-select");if(o){o.value=s;const d=new Event("change",{bubbles:!0});o.dispatchEvent(d)}}},100)}F&&F.classList.add("open")}function X(){F&&F.classList.remove("open"),V=null}ge&&ge.addEventListener("click",X);ke&&ke.addEventListener("click",X);F&&F.addEventListener("click",e=>{e.target===F&&X()});Y&&Y.addEventListener("click",async()=>{var a;if(V===null||!w||!l){alert("No task selected.");return}const e=l.frequency||"Monthly",n=((a=x==null?void 0:x.querySelector(".calendar-year-select"))==null?void 0:a.value)||new Date().getFullYear(),t=se(x,e,parseInt(n));if(!t||Object.keys(t).length===0){alert("Please select at least one date.");return}Y.disabled=!0,Y.textContent="Saving...";try{const c=l.scheduleDates||{};Object.assign(c,t);const s=l.taskDates||[],i=Object.keys(t);i.length>0&&(s[V]=t[i[0]]),await ae(H(U,"maintenance",w),{scheduleDates:c,scheduleYear:parseInt(n),taskDates:s,updatedAt:new Date().toISOString()}),l.scheduleDates=c,l.scheduleYear=parseInt(n),l.taskDates=s,alert("Calendar saved successfully!"),X(),z()}catch(c){console.error("Error saving task calendar:",c),alert("Failed to save calendar. Please try again.")}finally{Y.disabled=!1,Y.textContent="Save Date"}});z();pe&&$&&N&&pe.addEventListener("change",e=>{const n=e.target.value;if(n){$.style.display="block";const t=(l==null?void 0:l.scheduleDates)||{};l!=null&&l.scheduleYear||new Date().getFullYear(),W(n,N,t)}else $.style.display="none",N.innerHTML=""});te&&P&&(te.addEventListener("click",e=>{e.stopPropagation(),P.classList.toggle("open")}),document.addEventListener("click",e=>{!te.contains(e.target)&&!P.contains(e.target)&&P.classList.remove("open")}));me&&me.addEventListener("click",()=>{P.classList.remove("open"),Ne()});function Ne(){if(!l||!w){alert("Maintenance data not loaded.");return}document.getElementById("edit-branch").value=l.branch||"",document.getElementById("edit-location").value=l.location||"",document.getElementById("edit-itemName").value=l.itemName||"";const e=l.frequency||"Monthly";document.getElementById("edit-frequency").value=e;let n=l.inspectionTasks||[];if(typeof n=="string"?n=n.split(`
`).filter(t=>t.trim()):Array.isArray(n)||(n=[]),document.getElementById("edit-inspectionTasks").value=n.join(`
`),$&&N){$.style.display="block";const t=l.scheduleDates||{};l.scheduleYear||new Date().getFullYear(),W(e,N,t)}else $&&($.style.display="none");J.classList.add("open")}function Z(){J.classList.remove("open")}ye&&ye.addEventListener("click",Z);fe&&fe.addEventListener("click",Z);J&&J.addEventListener("click",e=>{e.target===J&&Z()});ne&&ne.addEventListener("submit",async e=>{var n,t,a,c,s;if(e.preventDefault(),!w){alert("No maintenance item selected.");return}O.disabled=!0,O.textContent="Saving...";try{const i=new FormData(ne),f=(((n=i.get("inspectionTasks"))==null?void 0:n.trim())||"").split(`
`).map(r=>r.trim()).filter(r=>r.length>0),o=i.get("frequency")||"Monthly",d=((t=N==null?void 0:N.querySelector(".calendar-year-select"))==null?void 0:t.value)||(l==null?void 0:l.scheduleYear)||new Date().getFullYear(),E=se(N,o,parseInt(d)),g=[];o==="Weekly"?f.forEach((r,m)=>{for(let p=0;p<12;p++){for(let h=1;h<=4;h++){const u=`${d}-${p}-${h}`;if(E[u]){g[m]=E[u];break}}if(g[m])break}}):o==="Monthly"?f.forEach((r,m)=>{const p=m%12,h=`${d}-${p}`;g[m]=E[h]||""}):o==="Quarterly"&&f.forEach((r,m)=>{const p=Math.floor(m/3),h=m%3,u=`${d}-${p}-${h}`;g[m]=E[u]||""});const k=(l==null?void 0:l.taskDates)||[];f.forEach((r,m)=>{k[m]&&!g[m]&&(g[m]=k[m])});const v={branch:((a=i.get("branch"))==null?void 0:a.trim())||"",location:((c=i.get("location"))==null?void 0:c.trim())||"",itemName:((s=i.get("itemName"))==null?void 0:s.trim())||"",frequency:o,inspectionTasks:f,scheduleDates:E,scheduleYear:parseInt(d),taskDates:g,updatedAt:new Date().toISOString()};if(!v.branch||!v.location||!v.itemName||f.length===0){alert("All fields are required. Please fill in all fields."),O.disabled=!1,O.textContent="Save Changes";return}await ae(H(U,"maintenance",w),v),alert("Maintenance item updated successfully!"),Z(),z()}catch(i){console.error("Error updating maintenance item:",i),alert("Failed to update maintenance item. Please try again.")}finally{O.disabled=!1,O.textContent="Save Changes"}});ue&&ue.addEventListener("click",async()=>{if(P.classList.remove("open"),!w){alert("No maintenance item selected.");return}if(!(!confirm(`Are you sure you want to delete this maintenance item?

This action cannot be undone and the maintenance item will be permanently removed from the database.`)||!confirm(`⚠️ WARNING: This will permanently delete the maintenance item from the database.

Click OK to confirm deletion.`)))try{await we(H(U,"maintenance",w)),alert("Maintenance item deleted successfully!"),window.location.href="maintenance.html"}catch(t){console.error("Error deleting maintenance item:",t),alert("Failed to delete maintenance item. Please try again.")}});document.getElementById("logout-btn").addEventListener("click",async()=>{try{await Ie(Ee),window.location.href="index.html"}catch(e){console.error("Logout error:",e),alert("Error logging out. Please try again.")}});const S=document.getElementById("sidebar"),ve=document.getElementById("sidebar-toggle-btn"),B=document.getElementById("toggle-icon");if(S&&ve&&B){localStorage.getItem("sidebarCollapsed")==="true"?(S.classList.add("collapsed"),B.textContent="→"):B.textContent="☰",ve.addEventListener("click",t=>{t.stopPropagation(),t.preventDefault(),S.classList.contains("collapsed"),B.style.opacity="0",B.style.transform="scale(0.8)",setTimeout(()=>{S.classList.toggle("collapsed"),S.classList.contains("collapsed")?B.textContent="→":B.textContent="☰",setTimeout(()=>{B.style.opacity="1",B.style.transform="scale(1)"},50);const a=document.querySelector(".app-shell");a&&(S.classList.contains("collapsed")?a.classList.add("has-collapsed-sidebar"):a.classList.remove("has-collapsed-sidebar")),localStorage.setItem("sidebarCollapsed",S.classList.contains("collapsed")?"true":"false")},150)});const n=document.querySelector(".app-shell");n&&S.classList.contains("collapsed")&&n.classList.add("has-collapsed-sidebar"),B.style.opacity="1",B.style.transform="scale(1)"}
