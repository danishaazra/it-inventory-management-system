import"./qrcode-DEXsfuzH.js";import{H as Y,J as ve}from"./firebase-vendor-B2UDLW_X.js";import{onAuthStateChanged as Ee}from"./firebase-auth-CnPx9bWP.js";import"./firebase-app-D-fiV83C.js";import{getDoc as ge,doc as P,updateDoc as te,deleteDoc as be}from"./firebase-firestore-BFWK-5cG.js";import"./vendor-BdN5Q6dY.js";const J=document.getElementById("user-name"),W=document.getElementById("user-avatar"),ae=document.getElementById("summary-branch"),se=document.getElementById("summary-location"),oe=document.getElementById("summary-itemName"),K=document.getElementById("summary-frequency"),Q=document.getElementById("tasks-list"),le=document.getElementById("add-task-btn"),x=document.getElementById("add-task-modal-overlay"),ce=document.getElementById("close-add-task-modal-btn"),ie=document.getElementById("cancel-add-task-btn"),$=document.getElementById("add-task-form"),M=document.getElementById("save-add-task-btn"),Z=document.getElementById("add-task-schedule-container"),B=document.getElementById("add-task-schedule-calendar"),_=document.getElementById("inspection-actions-btn"),O=document.getElementById("inspection-actions-menu"),de=document.getElementById("edit-maintenance-btn"),re=document.getElementById("delete-maintenance-btn"),U=document.getElementById("edit-modal-overlay"),me=document.getElementById("close-modal-btn"),ue=document.getElementById("cancel-edit-btn"),ee=document.getElementById("edit-maintenance-form"),q=document.getElementById("save-edit-btn"),ye=document.getElementById("edit-frequency"),L=document.getElementById("edit-schedule-container"),N=document.getElementById("edit-schedule-calendar");let w=null,l=null;Ee(ve,async e=>{if(e)try{let n=e.email||"User";const t=await ge(P(Y,"users",e.uid));if(t.exists()){const s=t.data();n=s.fullName||s.name||e.email||"User"}if(J&&(J.textContent=n),W){const s=n.trim().charAt(0).toUpperCase();W.textContent=s||"U"}}catch(n){console.error("Error loading user data for header:",n);const t=e&&(e.displayName||e.email)||"User";if(J&&(J.textContent=t),W){const s=t.trim().charAt(0).toUpperCase();W.textContent=s||"U"}}});function Ce(e){const n=e.toLowerCase();return n.includes("weekly")?"frequency-weekly":n.includes("monthly")?"frequency-monthly":n.includes("quarterly")?"frequency-quarterly":""}function H(e,n,t={}){n.innerHTML="";const s=new Date().getFullYear(),c=document.createElement("select");c.className="calendar-year-select";for(let f=s;f<=s+2;f++){const o=document.createElement("option");o.value=f,o.textContent=f,f===s&&(o.selected=!0),c.appendChild(o)}const a=document.createElement("div");a.className="calendar-year-selector";const d=document.createElement("label");d.textContent="Year: ",d.style.fontWeight="600",a.appendChild(d),a.appendChild(c),n.appendChild(a);const b=document.createElement("div");b.className="calendar-months",e==="Weekly"?["January","February","March","April","May","June","July","August","September","October","November","December"].forEach((o,i)=>{const E=document.createElement("div");E.className="calendar-month";const g=document.createElement("div");g.className="calendar-month-header",g.textContent=o,E.appendChild(g);const k=document.createElement("div");k.className="calendar-weeks";for(let v=1;v<=4;v++){const r=document.createElement("div");r.className="calendar-week";const m=document.createElement("div");m.className="calendar-week-label",m.textContent=`Week ${v}:`,r.appendChild(m);const p=document.createElement("input");p.type="date",p.className="calendar-date-input",p.dataset.month=i,p.dataset.week=v,p.dataset.key=`${i}-${v}`;const h=parseInt(c.value),u=new Date(h,i,1).getDay(),C=u===0?2:u===1?1:9-u,D=new Date(h,i,C+(v-1)*7);D.getMonth()===i&&(p.value=D.toISOString().split("T")[0]);const y=`${h}-${i}-${v}`;t[y]&&(p.value=t[y]),r.appendChild(p),k.appendChild(r)}E.appendChild(k),b.appendChild(E)}):e==="Monthly"?["January","February","March","April","May","June","July","August","September","October","November","December"].forEach((o,i)=>{const E=document.createElement("div");E.className="calendar-month";const g=document.createElement("div");g.className="calendar-month-header",g.textContent=o,E.appendChild(g);const k=document.createElement("input");k.type="date",k.className="calendar-date-input",k.dataset.month=i,k.dataset.key=`${i}`;const v=parseInt(c.value),r=new Date(v,i,1);k.value=r.toISOString().split("T")[0];const m=`${v}-${i}`;t[m]&&(k.value=t[m]),E.appendChild(k),b.appendChild(E)}):e==="Quarterly"&&[{name:"Q1",months:["January","February","March"],monthIndices:[0,1,2]},{name:"Q2",months:["April","May","June"],monthIndices:[3,4,5]},{name:"Q3",months:["July","August","September"],monthIndices:[6,7,8]},{name:"Q4",months:["October","November","December"],monthIndices:[9,10,11]}].forEach((o,i)=>{const E=document.createElement("div");E.className="calendar-quarter";const g=document.createElement("div");g.className="calendar-quarter-label",g.textContent=o.name,E.appendChild(g);const k=document.createElement("div");k.style.display="flex",k.style.alignItems="center",k.style.gap="0.5rem",k.style.marginBottom="0.5rem";const v=document.createElement("label");v.textContent="Select Month:",v.style.minWidth="100px",v.style.fontSize="0.85rem",v.style.fontWeight="600",k.appendChild(v);const r=document.createElement("select");r.className="calendar-month-select",r.dataset.quarter=i,r.dataset.key=`${i}`;const m=document.createElement("option");m.value="",m.textContent="Choose month...",r.appendChild(m),o.months.forEach((C,D)=>{const y=o.monthIndices[D],I=document.createElement("option");I.value=y,I.textContent=C,r.appendChild(I)});const p=parseInt(c.value);let h=null;for(let C=0;C<o.months.length;C++){const D=o.monthIndices[C],y=`${p}-${i}-${C}`;if(t[y]){h=D,r.value=D;break}}k.appendChild(r);const u=document.createElement("input");if(u.type="date",u.className="calendar-date-input",u.dataset.quarter=i,u.dataset.key=`${i}`,u.style.display=h!==null?"block":"none",u.style.marginTop="0.5rem",h!==null){for(let C=0;C<o.months.length;C++)if(o.monthIndices[C]===h){const y=`${p}-${i}-${C}`;if(t[y])u.value=t[y];else{const I=new Date(p,h,1);u.value=I.toISOString().split("T")[0]}break}}r.addEventListener("change",()=>{if(r.value){const C=parseInt(r.value);u.style.display="block";const D=new Date(p,C,1);u.value=D.toISOString().split("T")[0];for(let y=0;y<o.months.length;y++)if(o.monthIndices[y]===C){const I=`${p}-${i}-${y}`;t[I]&&(u.value=t[I]);break}}else u.style.display="none",u.value=""}),E.appendChild(k),E.appendChild(u),b.appendChild(E)}),n.appendChild(b),c.addEventListener("change",()=>{H(e,n,t)})}function ne(e,n,t){const s={};return e.querySelectorAll(".calendar-date-input").forEach(a=>{if(a.value&&a.style.display!=="none"){const d=a.dataset.key;if(n==="Weekly"){const[b,f]=d.split("-");s[`${t}-${b}-${f}`]=a.value}else if(n==="Monthly"){const b=d;s[`${t}-${b}`]=a.value}else if(n==="Quarterly"){const b=parseInt(d),f=e.querySelector(`select[data-quarter="${b}"]`);if(f&&f.value){const o=parseInt(f.value),g=[{monthIndices:[0,1,2]},{monthIndices:[3,4,5]},{monthIndices:[6,7,8]},{monthIndices:[9,10,11]}][b].monthIndices.indexOf(o);g!==-1&&(s[`${t}-${b}-${g}`]=a.value)}}}}),s}async function R(){const n=new URLSearchParams(window.location.search).get("id");if(!n){alert("No maintenance item ID provided."),window.location.replace("/maintenance/maintenance.html");return}w=n;try{const t=await ge(P(Y,"maintenance",n));if(!t.exists()){alert("Maintenance item not found."),window.location.replace("/maintenance/maintenance.html");return}const s=t.data();if(l=s,ae&&(ae.textContent=s.branch||"Not set"),se&&(se.textContent=s.location||"Not set"),oe&&(oe.textContent=s.itemName||"Not set"),K){K.innerHTML="";const c=s.frequency||"Not set",a=Ce(c);if(a){const d=document.createElement("span");d.className=`frequency-badge ${a}`,d.textContent=c,K.appendChild(d)}else K.textContent=c}if(Q){Q.innerHTML="";let c=s.inspectionTasks||[];if(typeof c=="string"?c=c.split(`
`).filter(a=>a.trim()):Array.isArray(c)||(c=[]),!c||c.length===0){const a=document.createElement("li");a.className="no-tasks",a.textContent="No inspection tasks found.",Q.appendChild(a)}else c.forEach((a,d)=>{const b=document.createElement("li");b.className="task-item";const f=document.createElement("div");f.className="task-number",f.textContent=d+1,b.appendChild(f);const o=document.createElement("div");o.className="task-text",o.style.flex="1";const i=document.createElement("div");i.style.fontSize="1rem",i.style.fontWeight="600",i.style.marginBottom="0.5rem",i.textContent=a,o.appendChild(i);let g=(s.taskDates||[])[d]||"";const k=document.createElement("div");k.className="task-date";const v=document.createElement("div");if(v.className="task-date-info",g){const h=new Date(g),u=new Date;u.setHours(0,0,0,0);const C=new Date(h.getFullYear(),h.getMonth(),h.getDate());let D=Math.ceil((C-u)/(1e3*60*60*24)),y=h;const I=s.frequency||"Monthly";if(D<0){if(I==="Weekly")for(;y<=u;)y=new Date(y.getTime()+7*24*60*60*1e3);else if(I==="Monthly")for(;y<=u;)y=new Date(y.getFullYear(),y.getMonth()+1,y.getDate());else if(I==="Quarterly")for(;y<=u;)y=new Date(y.getFullYear(),y.getMonth()+3,y.getDate());const ke=new Date(y.getFullYear(),y.getMonth(),y.getDate());D=Math.ceil((ke-u)/(1e3*60*60*24))}const X=document.createElement("div");X.className="task-date-value",X.textContent=`Upcoming: ${y.toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"})}`,v.appendChild(X);const T=document.createElement("div");T.className="task-days-remaining",D===0?(T.textContent="Today",T.style.background="#fee2e2",T.style.color="#991b1b"):D===1?(T.textContent="Tomorrow",T.style.background="#fef3c7",T.style.color="#92400e"):(T.textContent=`${D} days remaining`,T.style.background="#dbeafe",T.style.color="#1e40af"),v.appendChild(T)}else{const h=document.createElement("div");h.className="task-date-label",h.textContent="No date scheduled",h.style.color="#9ca3af",v.appendChild(h)}k.appendChild(v);const r=document.createElement("div");r.style.display="flex",r.style.gap="0.5rem",r.style.alignItems="center";const m=document.createElement("button");m.type="button",m.className="task-date-edit-btn",m.textContent="Edit Calendar",m.style.cursor="pointer",m.addEventListener("click",()=>{const h=s.frequency||"Monthly",u=s.scheduleDates||{},C=s.scheduleYear||new Date().getFullYear();we(d,a,g,h,u,C)}),r.appendChild(m);const p=document.createElement("a");p.href=`/inspection/inspectionassets.html?maintenanceId=${encodeURIComponent(w)}&taskIndex=${d}`,p.className="task-date-edit-btn",p.textContent="View more",p.style.textDecoration="none",p.style.display="inline-block",r.appendChild(p),k.appendChild(r),o.appendChild(k),b.appendChild(o),Q.appendChild(b)})}}catch(t){console.error("Error loading inspection tasks:",t),alert("Failed to load inspection tasks. Please try again."),window.location.replace("/maintenance/maintenance.html")}}function De(){if(console.log("openAddTaskModal called"),!x){console.error("Add Task modal overlay not found!");return}if($&&$.reset(),l&&B&&Z){const e=l.frequency||"Monthly";console.log("Generating calendar for frequency:",e),Z.style.display="block",H(e,B)}else console.warn("Calendar elements not found:",{currentMaintenanceData:!!l,addTaskScheduleCalendar:!!B,addTaskScheduleContainer:!!Z});x.classList.add("open"),console.log("Modal opened")}function V(){x&&(x.classList.remove("open"),$&&$.reset(),B&&(B.innerHTML=""))}le?le.addEventListener("click",e=>{if(e.preventDefault(),e.stopPropagation(),console.log("Add Task button clicked"),!w){alert("Maintenance item not loaded. Please wait for the page to finish loading.");return}if(!l){alert("Maintenance data not loaded. Please wait for the page to finish loading.");return}console.log("Opening Add Task modal"),De()}):console.error("Add Task button not found!");ce&&ce.addEventListener("click",V);ie&&ie.addEventListener("click",V);x&&x.addEventListener("click",e=>{e.target===x&&V()});$&&$.addEventListener("submit",async e=>{var n,t;if(e.preventDefault(),!w||!l){alert("Maintenance item not loaded.");return}if(M){M.disabled=!0,M.textContent="Adding...";try{const c=((n=new FormData($).get("taskText"))==null?void 0:n.trim())||"";if(!c){alert("Please enter a task description."),M.disabled=!1,M.textContent="Add Task";return}let a=l.inspectionTasks||[];typeof a=="string"?a=a.split(`
`).filter(g=>g.trim()):Array.isArray(a)||(a=[]),a.push(c);const d=l.frequency||"Monthly",b=((t=B==null?void 0:B.querySelector(".calendar-year-select"))==null?void 0:t.value)||new Date().getFullYear(),f=ne(B,d,parseInt(b)),o=Object.keys(f);if(o.length===0){alert("Please select a date for this task based on the frequency."),M.disabled=!1,M.textContent="Add Task";return}let i=f[o[0]]||"";const E=l.taskDates||[];E.push(i),await te(P(Y,"maintenance",w),{inspectionTasks:a,taskDates:E,updatedAt:new Date().toISOString()}),alert("Task added successfully!"),V(),await R()}catch(s){console.error("Error adding task:",s),alert("Failed to add task. Please try again.")}finally{M&&(M.disabled=!1,M.textContent="Add Task")}}});let j=null;const A=document.getElementById("task-date-modal-overlay"),fe=document.getElementById("task-date-modal-title"),S=document.getElementById("task-date-modal-calendar"),pe=document.getElementById("close-task-date-modal-btn"),he=document.getElementById("cancel-task-date-btn"),F=document.getElementById("save-task-date-btn");function Ie(e,n,t,s,c){const a={};return s&&s[e]&&s[e],!t||Object.keys(t).length===0||Object.keys(t).forEach(d=>{d.split("-")[0]==c&&(a[d]=t[d])}),a}function we(e,n,t,s,c,a){if(j=e,fe&&(fe.textContent=`Edit Calendar: ${n}`),S){S.innerHTML="";const d=a||new Date().getFullYear(),b=(l==null?void 0:l.taskDates)||[],f=Ie(e,s,c||{},b,d);H(s,S,f),setTimeout(()=>{if(a){const o=S.querySelector(".calendar-year-select");if(o){o.value=a;const i=new Event("change",{bubbles:!0});o.dispatchEvent(i)}}},100)}A&&A.classList.add("open")}function z(){A&&A.classList.remove("open"),j=null}pe&&pe.addEventListener("click",z);he&&he.addEventListener("click",z);A&&A.addEventListener("click",e=>{e.target===A&&z()});F&&F.addEventListener("click",async()=>{var s;if(j===null||!w||!l){alert("No task selected.");return}const e=l.frequency||"Monthly",n=((s=S==null?void 0:S.querySelector(".calendar-year-select"))==null?void 0:s.value)||new Date().getFullYear(),t=ne(S,e,parseInt(n));if(!t||Object.keys(t).length===0){alert("Please select at least one date.");return}F.disabled=!0,F.textContent="Saving...";try{const c=l.scheduleDates||{};Object.assign(c,t);const a=l.taskDates||[],d=Object.keys(t);d.length>0&&(a[j]=t[d[0]]),await te(P(Y,"maintenance",w),{scheduleDates:c,scheduleYear:parseInt(n),taskDates:a,updatedAt:new Date().toISOString()}),l.scheduleDates=c,l.scheduleYear=parseInt(n),l.taskDates=a,alert("Calendar saved successfully!"),z(),R()}catch(c){console.error("Error saving task calendar:",c),alert("Failed to save calendar. Please try again.")}finally{F.disabled=!1,F.textContent="Save Date"}});R();ye&&L&&N&&ye.addEventListener("change",e=>{const n=e.target.value;if(n){L.style.display="block";const t=(l==null?void 0:l.scheduleDates)||{};l!=null&&l.scheduleYear||new Date().getFullYear(),H(n,N,t)}else L.style.display="none",N.innerHTML=""});_&&O&&(_.addEventListener("click",e=>{e.stopPropagation(),O.classList.toggle("open")}),document.addEventListener("click",e=>{!_.contains(e.target)&&!O.contains(e.target)&&O.classList.remove("open")}));de&&de.addEventListener("click",()=>{O.classList.remove("open"),Te()});function Te(){if(!l||!w){alert("Maintenance data not loaded.");return}document.getElementById("edit-branch").value=l.branch||"",document.getElementById("edit-location").value=l.location||"",document.getElementById("edit-itemName").value=l.itemName||"";const e=l.frequency||"Monthly";document.getElementById("edit-frequency").value=e;let n=l.inspectionTasks||[];if(typeof n=="string"?n=n.split(`
`).filter(t=>t.trim()):Array.isArray(n)||(n=[]),document.getElementById("edit-inspectionTasks").value=n.join(`
`),L&&N){L.style.display="block";const t=l.scheduleDates||{};l.scheduleYear||new Date().getFullYear(),H(e,N,t)}else L&&(L.style.display="none");U.classList.add("open")}function G(){U.classList.remove("open")}me&&me.addEventListener("click",G);ue&&ue.addEventListener("click",G);U&&U.addEventListener("click",e=>{e.target===U&&G()});ee&&ee.addEventListener("submit",async e=>{var n,t,s,c,a;if(e.preventDefault(),!w){alert("No maintenance item selected.");return}q.disabled=!0,q.textContent="Saving...";try{const d=new FormData(ee),f=(((n=d.get("inspectionTasks"))==null?void 0:n.trim())||"").split(`
`).map(r=>r.trim()).filter(r=>r.length>0),o=d.get("frequency")||"Monthly",i=((t=N==null?void 0:N.querySelector(".calendar-year-select"))==null?void 0:t.value)||(l==null?void 0:l.scheduleYear)||new Date().getFullYear(),E=ne(N,o,parseInt(i)),g=[];o==="Weekly"?f.forEach((r,m)=>{for(let p=0;p<12;p++){for(let h=1;h<=4;h++){const u=`${i}-${p}-${h}`;if(E[u]){g[m]=E[u];break}}if(g[m])break}}):o==="Monthly"?f.forEach((r,m)=>{const p=m%12,h=`${i}-${p}`;g[m]=E[h]||""}):o==="Quarterly"&&f.forEach((r,m)=>{const p=Math.floor(m/3),h=m%3,u=`${i}-${p}-${h}`;g[m]=E[u]||""});const k=(l==null?void 0:l.taskDates)||[];f.forEach((r,m)=>{k[m]&&!g[m]&&(g[m]=k[m])});const v={branch:((s=d.get("branch"))==null?void 0:s.trim())||"",location:((c=d.get("location"))==null?void 0:c.trim())||"",itemName:((a=d.get("itemName"))==null?void 0:a.trim())||"",frequency:o,inspectionTasks:f,scheduleDates:E,scheduleYear:parseInt(i),taskDates:g,updatedAt:new Date().toISOString()};if(!v.branch||!v.location||!v.itemName||f.length===0){alert("All fields are required. Please fill in all fields."),q.disabled=!1,q.textContent="Save Changes";return}await te(P(Y,"maintenance",w),v),alert("Maintenance item updated successfully!"),G(),R()}catch(d){console.error("Error updating maintenance item:",d),alert("Failed to update maintenance item. Please try again.")}finally{q.disabled=!1,q.textContent="Save Changes"}});re&&re.addEventListener("click",async()=>{if(O.classList.remove("open"),!w){alert("No maintenance item selected.");return}if(!(!confirm(`Are you sure you want to delete this maintenance item?

This action cannot be undone and the maintenance item will be permanently removed from the database.`)||!confirm(`⚠️ WARNING: This will permanently delete the maintenance item from the database.

Click OK to confirm deletion.`)))try{await be(P(Y,"maintenance",w)),alert("Maintenance item deleted successfully!"),window.location.replace("/maintenance/maintenance.html")}catch(t){console.error("Error deleting maintenance item:",t),alert("Failed to delete maintenance item. Please try again.")}});
