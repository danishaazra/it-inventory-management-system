const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/firebase-firestore-DyzXcozE.js","assets/firebase-app-CdRXrjY0.js","assets/firebase-vendor-BDhSju_T.js","assets/vendor-BdN5Q6dY.js","assets/firebase-auth-V8RQ8eEz.js"])))=>i.map(i=>d[i]);
import{_ as st}from"./qrcode-_3APf9r8.js";import{H as b,J as Y}from"./firebase-vendor-BDhSju_T.js";import{o as it,s as rt}from"./firebase-auth-V8RQ8eEz.js";import"./firebase-app-CdRXrjY0.js";import{getDoc as ct,doc as dt,query as R,collection as v,limit as q,getDocs as Q,addDoc as Z}from"./firebase-firestore-DyzXcozE.js";import{r as lt,u as mt}from"./xlsx-vendor-DLNWaC59.js";import"./vendor-BdN5Q6dY.js";(async()=>{try{const{enableIndexedDbPersistence:e}=await st(async()=>{const{enableIndexedDbPersistence:t}=await import("./firebase-firestore-DyzXcozE.js");return{enableIndexedDbPersistence:t}},__vite__mapDeps([0,1,2,3,4]));await e(b),console.log("Firestore persistence enabled")}catch(e){e.code!=="failed-precondition"&&e.code!=="unimplemented"&&console.warn("Persistence setup failed:",e.message)}})();const H=document.getElementById("user-name"),O=document.getElementById("user-avatar"),pt=document.getElementById("add-asset-btn-table"),gt=document.getElementById("add-asset-menu-table"),U=document.getElementById("asset-file-input"),C=document.getElementById("asset-table-body"),u=document.getElementById("add-locationDescription"),y=document.getElementById("add-locationDescription-custom"),A=document.getElementById("toggle-custom-location");it(Y,async e=>{if(e)try{let t=e.email||"User";const n=await ct(dt(b,"users",e.uid));if(n.exists()){const r=n.data();t=r.fullName||r.name||e.email||"User"}if(H&&(H.textContent=t),O){const r=t.trim().charAt(0).toUpperCase();O.textContent=r||"U"}}catch(t){console.error("Error loading user data for header:",t);const n=e&&(e.displayName||e.email)||"User";if(H&&(H.textContent=n),O){const r=n.trim().charAt(0).toUpperCase();O.textContent=r||"U"}}});function ft(e,t){!e||!t||(e.addEventListener("click",n=>{n.stopPropagation(),t.classList.toggle("open")}),t.addEventListener("click",n=>{const r=n.target.closest("button[data-action]");if(!r)return;const d=r.getAttribute("data-action");d==="manual"?yt():d==="upload"&&U&&U.click(),t.classList.remove("open")}),document.addEventListener("click",()=>{t.classList.remove("open")}))}ft(pt,gt);const S=document.getElementById("add-modal-overlay"),G=document.getElementById("close-add-modal-btn"),K=document.getElementById("cancel-add-btn"),I=document.getElementById("add-asset-form"),E=document.getElementById("save-add-btn");let D=null,F=0;const tt=10*60*1e3;async function ut(){if(!u)return;const e=Date.now();if(D&&e-F<tt){W(D);return}if(u){const t=document.createElement("option");t.value="",t.textContent="Loading locations...",t.disabled=!0,u.innerHTML="",u.appendChild(t)}try{const t=performance.now(),n=new Set,r=R(v(b,"maintenance"),q(100)),d=R(v(b,"assets"),q(500)),[m,g]=await Promise.all([Q(r).catch(s=>(console.error("Error loading maintenance:",s),{docs:[],empty:!0,forEach:()=>{}})),Q(d).catch(s=>(console.error("Error loading assets:",s),{docs:[],empty:!0,forEach:()=>{}}))]);m.forEach(s=>{const a=s.data();(Array.isArray(a.inspectionTasks)?a.inspectionTasks:typeof a.inspectionTasks=="string"?a.inspectionTasks.split(`
`).filter(l=>l.trim()):[]).forEach(l=>{l&&l.trim()!==""&&n.add(l.trim())})}),g.forEach(s=>{const a=s.data();a.locationDescription&&a.locationDescription.trim()!==""&&n.add(a.locationDescription.trim())});const f=performance.now()-t;console.log(`Loaded ${n.size} locations in ${f.toFixed(2)}ms`),D=Array.from(n).sort(),F=e,W(D)}catch(t){console.error("Error loading locations:",t),u&&(u.innerHTML='<option value="">Error loading locations</option>')}}function W(e){u&&(u.innerHTML='<option value="">Select location...</option>',e.forEach(t=>{const n=document.createElement("option");n.value=t,n.textContent=t,u.appendChild(n)}))}A&&y&&A.addEventListener("click",()=>{y.style.display==="none"?(y.style.display="block",A.textContent="Use dropdown",u.value=""):(y.style.display="none",y.value="",A.textContent="+ Add custom location")});function yt(){S&&(I&&(I.reset(),y&&(y.style.display="none"),A&&(A.textContent="+ Add custom location")),ut(),S.classList.add("open"))}function z(){S&&(S.classList.remove("open"),I&&I.reset())}G&&G.addEventListener("click",z);K&&K.addEventListener("click",z);S&&S.addEventListener("click",e=>{e.target===S&&z()});I&&I.addEventListener("submit",async e=>{var t,n,r,d,m,g,f,s,a,o,l,c,p,T,h,w,M,k,J;if(e.preventDefault(),!!E){E.disabled=!0,E.textContent="Adding...";try{const i=new FormData(I);let x=y&&y.style.display!=="none"?((t=i.get("locationDescriptionCustom"))==null?void 0:t.trim())||"":((n=i.get("locationDescription"))==null?void 0:n.trim())||"";if(x){const L=x.toLowerCase().trim();let ht=[];const et=Date.now();if(!(D&&et-F<tt))try{const V=R(v(b,"maintenance"),q(100)),nt=await Q(V);for(const ot of nt.docs){const _=ot.data(),at=Array.isArray(_.inspectionTasks)?_.inspectionTasks:typeof _.inspectionTasks=="string"?_.inspectionTasks.split(`
`).filter(N=>N.trim()):[];for(const N of at)if(N&&N.trim().toLowerCase()===L){x=N.trim();break}if(x!==L)break}}catch(V){console.warn("Error loading maintenance for location matching:",V)}}const B={no:((r=i.get("no"))==null?void 0:r.trim())||"",branchCode:((d=i.get("branchCode"))==null?void 0:d.trim())||"",assetId:(m=i.get("assetId"))==null?void 0:m.trim(),assetDescription:((g=i.get("assetDescription"))==null?void 0:g.trim())||"",assetCategory:((f=i.get("assetCategory"))==null?void 0:f.trim())||"",assetCategoryDescription:((s=i.get("assetCategoryDescription"))==null?void 0:s.trim())||"",ownerCode:((a=i.get("ownerCode"))==null?void 0:a.trim())||"",ownerName:((o=i.get("ownerName"))==null?void 0:o.trim())||"",model:((l=i.get("model"))==null?void 0:l.trim())||"",brand:((c=i.get("brand"))==null?void 0:c.trim())||"",status:i.get("status")||"Active",warrantyPeriod:((p=i.get("warrantyPeriod"))==null?void 0:p.trim())||"",serialNo:((T=i.get("serialNo"))==null?void 0:T.trim())||"",location:((h=i.get("location"))==null?void 0:h.trim())||"",locationDescription:x,area:((w=i.get("area"))==null?void 0:w.trim())||"",departmentCode:((M=i.get("departmentCode"))==null?void 0:M.trim())||"",departmentDescription:((k=i.get("departmentDescription"))==null?void 0:k.trim())||"",condition:i.get("condition")||"",currentUser:((J=i.get("currentUser"))==null?void 0:J.trim())||"",createdAt:new Date().toISOString()};if(Object.keys(B).forEach(L=>{L!=="createdAt"&&B[L]===""&&delete B[L]}),!B.assetId){alert("Asset ID is required."),E.disabled=!1,E.textContent="Add Asset";return}await Z(v(b,"assets"),B),D=null,F=0,alert("Asset added successfully!"),z(),await j()}catch(i){console.error("Error adding asset:",i),alert("Failed to add asset. Please try again.")}finally{E&&(E.disabled=!1,E.textContent="Add Asset")}}});async function j(){if(C){C.innerHTML='<tr><td colspan="8" style="text-align: center; padding: 2rem; color: #666;">Loading assets...</td></tr>';try{const e=performance.now(),t=R(v(b,"assets"),q(1e3)),n=await Q(t),r=performance.now()-e;if(console.log(`Loaded ${n.size} assets in ${r.toFixed(2)}ms`),C.innerHTML="",n.empty){const s=document.createElement("tr"),a=document.createElement("td");a.colSpan=8,a.textContent="No assets found. Upload a file to add assets.",a.style.color="#666",s.appendChild(a),C.appendChild(s);return}const d=[];n.forEach(s=>{d.push({id:s.id,data:s.data()})});const m=50,g=d.slice(0,m),f=d.slice(m);if(g.forEach(({id:s,data:a})=>{const o=document.createElement("tr");[a.assetId||"",a.assetDescription||"",a.assetCategoryDescription||a.assetCategory||"",a.model||"",a.serialNo||"",a.location||"",a.area||""].forEach(T=>{const h=document.createElement("td");h.textContent=T,o.appendChild(h)});const c=document.createElement("td"),p=document.createElement("a");p.className="action-link",p.href=`assetdetails.html?id=${encodeURIComponent(s)}`,p.textContent="View more",c.appendChild(p),o.appendChild(c),C.appendChild(o)}),f.length>0){let s=0;const a=()=>{f.slice(s,s+m).forEach(({id:l,data:c})=>{const p=document.createElement("tr");[c.assetId||"",c.assetDescription||"",c.assetCategoryDescription||c.assetCategory||"",c.model||"",c.serialNo||"",c.location||"",c.area||""].forEach(M=>{const k=document.createElement("td");k.textContent=M,p.appendChild(k)});const h=document.createElement("td"),w=document.createElement("a");w.className="action-link",w.href=`assetdetails.html?id=${encodeURIComponent(l)}`,w.textContent="View more",h.appendChild(w),p.appendChild(h),C.appendChild(p)}),s+=m,s<f.length&&requestAnimationFrame(a)};requestAnimationFrame(a)}}catch(e){console.error("Error loading assets:",e),C.innerHTML="";const t=document.createElement("tr"),n=document.createElement("td");n.colSpan=8,n.textContent="Failed to load assets. Please refresh.",n.style.color="#b91c1c",t.appendChild(n),C.appendChild(t)}}}U&&U.addEventListener("change",async e=>{const t=e.target.files[0];if(t)try{const n=await t.arrayBuffer(),r=lt(n,{type:"array"}),d=r.SheetNames[0],m=r.Sheets[d],g=mt.sheet_to_json(m,{header:1,defval:""});if(!g||g.length<=1){alert("The file appears to be empty or missing data rows.");return}const f=g.slice(1),s=v(b,"assets"),a=f.filter(o=>o&&o.length>0&&String(o[2]||"").trim()!=="").map(o=>{const l={no:String(o[0]??"").trim(),branchCode:String(o[1]??"").trim(),assetId:String(o[2]??"").trim(),assetDescription:String(o[3]??"").trim(),assetCategory:String(o[4]??"").trim(),assetCategoryDescription:String(o[5]??"").trim(),ownerCode:String(o[6]??"").trim(),ownerName:String(o[7]??"").trim(),model:String(o[8]??"").trim(),brand:String(o[9]??"").trim(),status:String(o[10]??"").trim(),warrantyPeriod:String(o[11]??"").trim(),serialNo:String(o[12]??"").trim(),location:String(o[13]??"").trim(),locationDescription:String(o[14]??"").trim(),area:String(o[15]??"").trim(),departmentCode:String(o[16]??"").trim(),departmentDescription:String(o[17]??"").trim(),condition:String(o[18]??"").trim(),currentUser:String(o[19]??"").trim(),sourceFile:t.name,createdAt:new Date().toISOString()};return Z(s,l)});if(D=null,F=0,a.length===0){alert("No valid asset rows found in the file.");return}await Promise.all(a),alert(`Successfully uploaded ${a.length} assets.`),await j()}catch(n){console.error("Error importing assets file:",n),alert("Failed to import file. Please check the format and try again.")}finally{U.value=""}});j();const $=document.getElementById("sidebar"),X=document.getElementById("sidebar-toggle-btn"),P=document.getElementById("toggle-icon");$&&X&&P&&(localStorage.getItem("sidebarCollapsed")==="true"?($.classList.add("collapsed"),P.textContent="→"):P.textContent="☰",X.addEventListener("click",t=>{t.stopPropagation(),$.classList.toggle("collapsed"),$.classList.contains("collapsed")?(P.textContent="→",localStorage.setItem("sidebarCollapsed","true")):(P.textContent="☰",localStorage.setItem("sidebarCollapsed","false"))}));document.getElementById("logout-btn").addEventListener("click",async()=>{try{await rt(Y),window.location.href="index.html"}catch(e){console.error("Logout error:",e),alert("Error logging out. Please try again.")}});
