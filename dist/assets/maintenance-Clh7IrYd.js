const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/firebase-firestore-DyzXcozE.js","assets/firebase-app-CdRXrjY0.js","assets/firebase-vendor-BDhSju_T.js","assets/vendor-BdN5Q6dY.js","assets/firebase-auth-V8RQ8eEz.js"])))=>i.map(i=>d[i]);
import{_ as Z}from"./qrcode-_3APf9r8.js";import{H as N,K as ee,N as G,J as B}from"./firebase-vendor-BDhSju_T.js";import{o as te,s as ne}from"./firebase-auth-V8RQ8eEz.js";import"./firebase-app-CdRXrjY0.js";import{getDoc as ae,doc as oe,query as se,collection as _,limit as ce,getDocs as re,addDoc as W}from"./firebase-firestore-DyzXcozE.js";import{r as Y,u as q}from"./xlsx-vendor-DLNWaC59.js";import"./vendor-BdN5Q6dY.js";(async()=>{try{const{enableIndexedDbPersistence:n}=await Z(async()=>{const{enableIndexedDbPersistence:e}=await import("./firebase-firestore-DyzXcozE.js");return{enableIndexedDbPersistence:e}},__vite__mapDeps([0,1,2,3,4]));await n(N),console.log("Firestore persistence enabled")}catch(n){n.code!=="failed-precondition"&&n.code!=="unimplemented"&&console.warn("Persistence setup failed:",n.message)}})();const P=document.getElementById("user-name"),O=document.getElementById("user-avatar"),$=document.getElementById("maintenance-table-body"),S=document.getElementById("add-maintenance-btn"),le=document.getElementById("add-maintenance-menu"),L=document.getElementById("maintenance-file-input"),A=document.getElementById("add-modal-overlay"),R=document.getElementById("close-add-modal-btn"),j=document.getElementById("cancel-add-btn"),M=document.getElementById("add-maintenance-form"),x=document.getElementById("save-add-btn"),z=document.getElementById("add-frequency"),F=document.getElementById("add-schedule-container"),T=document.getElementById("add-schedule-calendar");let Q=null;te(B,async n=>{if(!n){Q=null;return}Q||(Q=ee(G,"us-central1"),console.log("Functions instance initialized for user:",n.uid));try{let e=n.email||"User";const a=await ae(oe(N,"users",n.uid));if(a.exists()){const h=a.data();e=h.fullName||h.name||n.email||"User"}if(P&&(P.textContent=e),O){const h=e.trim().charAt(0).toUpperCase();O.textContent=h||"U"}}catch(e){console.error("Error loading user data for header:",e);const a=n&&(n.displayName||n.email)||"User";if(P&&(P.textContent=a),O){const h=a.trim().charAt(0).toUpperCase();O.textContent=h||"U"}}try{await H()}catch(e){console.error("Error loading maintenance schedule:",e)}});function ie(n){if(!n)return"";const e=n.toLowerCase();return e.includes("weekly")?"frequency-weekly":e.includes("monthly")?"frequency-monthly":e.includes("quarterly")?"frequency-quarterly":""}async function H(){if(console.log("Loading maintenance schedule..."),!$){console.error("maintenanceTableBody element not found!");return}$.innerHTML="";const n=document.createElement("tr"),e=document.createElement("td");e.colSpan=4,e.textContent="Loading...",e.style.textAlign="center",e.style.padding="2rem",e.style.color="#666",n.appendChild(e),$.appendChild(n);try{console.log("Fetching maintenance items from Firestore...");const a=performance.now(),h=se(_(N,"maintenance"),ce(1e3)),y=await re(h),p=performance.now()-a;if(console.log(`Maintenance items fetched: ${y.size} in ${p.toFixed(2)}ms`),$.innerHTML="",y.empty){const f=document.createElement("tr"),o=document.createElement("td");o.colSpan=5,o.textContent='No maintenance items found. Click "Add Maintenance" to add one.',o.style.color="#666",o.style.textAlign="center",o.style.padding="2rem",f.appendChild(o),$.appendChild(f);return}y.forEach(f=>{const o=f.data(),C=o.inspectionTasks||"",l=Array.isArray(C)?C:typeof C=="string"?C.split(`
`).filter(v=>v.trim()):[];console.log("Processing maintenance item:",f.id,o);const t=document.createElement("tr"),g=ie(o.frequency),u=document.createElement("td");u.textContent=o.branch||"",t.appendChild(u);const s=document.createElement("td");s.textContent=o.location||"",t.appendChild(s);const c=document.createElement("td");c.textContent=o.itemName||"",t.appendChild(c);const d=document.createElement("td"),E=document.createElement("span");E.className=`frequency-badge ${g}`,E.textContent=o.frequency||"",d.appendChild(E),t.appendChild(d);const r=document.createElement("td"),m=document.createElement("a");m.href=`inspectiontask.html?id=${encodeURIComponent(f.id)}`,m.className="inspection-tasks-link",m.textContent=`View Tasks (${l.length})`,r.appendChild(m),t.appendChild(r),$.appendChild(t)}),console.log("Maintenance schedule loaded successfully")}catch(a){console.error("Error loading maintenance schedule:",a),$.innerHTML="";const h=document.createElement("tr"),y=document.createElement("td");y.colSpan=5,y.textContent=`Failed to load maintenance schedule: ${a.message}. Please refresh.`,y.style.color="#b91c1c",y.style.textAlign="center",y.style.padding="2rem",h.appendChild(y),$.appendChild(h)}}function de(n,e){!n||!e||(n.addEventListener("click",a=>{a.stopPropagation(),e.classList.toggle("open")}),e.addEventListener("click",a=>{const h=a.target.closest("button[data-action]");if(!h)return;const y=h.getAttribute("data-action");y==="manual"?ue():y==="upload"&&L&&L.click(),e.classList.remove("open")}),document.addEventListener("click",()=>{e.classList.remove("open")}))}de(S,le);function X(n,e,a={}){e.innerHTML="";const h=new Date().getFullYear(),y=document.createElement("select");y.className="calendar-year-select";for(let C=h;C<=h+2;C++){const l=document.createElement("option");l.value=C,l.textContent=C,C===h&&(l.selected=!0),y.appendChild(l)}const p=document.createElement("div");p.className="calendar-year-selector";const f=document.createElement("label");f.textContent="Year: ",f.style.fontWeight="600",p.appendChild(f),p.appendChild(y),e.appendChild(p);const o=document.createElement("div");o.className="calendar-months",n==="Weekly"?["January","February","March","April","May","June","July","August","September","October","November","December"].forEach((l,t)=>{const g=document.createElement("div");g.className="calendar-month";const u=document.createElement("div");u.className="calendar-month-header",u.textContent=l,g.appendChild(u);const s=document.createElement("div");s.className="calendar-weeks";for(let c=1;c<=4;c++){const d=document.createElement("div");d.className="calendar-week";const E=document.createElement("div");E.className="calendar-week-label",E.textContent=`Week ${c}:`,d.appendChild(E);const r=document.createElement("input");r.type="date",r.className="calendar-date-input",r.dataset.month=t,r.dataset.week=c,r.dataset.key=`${t}-${c}`;const m=parseInt(y.value),v=new Date(m,t,1).getDay(),k=v===0?2:v===1?1:9-v,i=new Date(m,t,k+(c-1)*7);i.getMonth()===t&&(r.value=i.toISOString().split("T")[0]);const b=`${m}-${t}-${c}`;a[b]&&(r.value=a[b]),d.appendChild(r),s.appendChild(d)}g.appendChild(s),o.appendChild(g)}):n==="Monthly"?["January","February","March","April","May","June","July","August","September","October","November","December"].forEach((l,t)=>{const g=document.createElement("div");g.className="calendar-month";const u=document.createElement("div");u.className="calendar-month-header",u.textContent=l,g.appendChild(u);const s=document.createElement("input");s.type="date",s.className="calendar-date-input",s.dataset.month=t,s.dataset.key=`${t}`;const c=parseInt(y.value),d=new Date(c,t,1);s.value=d.toISOString().split("T")[0];const E=`${c}-${t}`;a[E]&&(s.value=a[E]),g.appendChild(s),o.appendChild(g)}):n==="Quarterly"&&[{name:"Q1",months:["January","February","March"],monthIndices:[0,1,2]},{name:"Q2",months:["April","May","June"],monthIndices:[3,4,5]},{name:"Q3",months:["July","August","September"],monthIndices:[6,7,8]},{name:"Q4",months:["October","November","December"],monthIndices:[9,10,11]}].forEach((l,t)=>{const g=document.createElement("div");g.className="calendar-quarter";const u=document.createElement("div");u.className="calendar-quarter-label",u.textContent=l.name,g.appendChild(u);const s=document.createElement("div");s.style.display="flex",s.style.alignItems="center",s.style.gap="0.5rem",s.style.marginBottom="0.5rem";const c=document.createElement("label");c.textContent="Select Month:",c.style.minWidth="100px",c.style.fontSize="0.85rem",c.style.fontWeight="600",s.appendChild(c);const d=document.createElement("select");d.className="calendar-month-select",d.dataset.quarter=t,d.dataset.key=`${t}`;const E=document.createElement("option");E.value="",E.textContent="Choose month...",d.appendChild(E),l.months.forEach((k,i)=>{const b=l.monthIndices[i],w=document.createElement("option");w.value=b,w.textContent=k,d.appendChild(w)});const r=parseInt(y.value);let m=null;for(let k=0;k<l.months.length;k++){const i=l.monthIndices[k],b=`${r}-${t}-${k}`;if(a[b]){m=i,d.value=i;break}}s.appendChild(d);const v=document.createElement("input");if(v.type="date",v.className="calendar-date-input",v.dataset.quarter=t,v.dataset.key=`${t}`,v.style.display=m!==null?"block":"none",v.style.marginTop="0.5rem",m!==null){for(let k=0;k<l.months.length;k++)if(l.monthIndices[k]===m){const b=`${r}-${t}-${k}`;if(a[b])v.value=a[b];else{const w=new Date(r,m,1);v.value=w.toISOString().split("T")[0]}break}}d.addEventListener("change",()=>{if(d.value){const k=parseInt(d.value);v.style.display="block";const i=new Date(r,k,1);v.value=i.toISOString().split("T")[0];for(let b=0;b<l.months.length;b++)if(l.monthIndices[b]===k){const w=`${r}-${t}-${b}`;a[w]&&(v.value=a[w]);break}}else v.style.display="none",v.value=""}),g.appendChild(s),g.appendChild(v),o.appendChild(g)}),e.appendChild(o),y.addEventListener("change",()=>{X(n,e,a)})}function me(n,e,a){const h={};return n.querySelectorAll(".calendar-date-input").forEach(p=>{if(p.value&&p.style.display!=="none"){const f=p.dataset.key;if(e==="Weekly"){const[o,C]=f.split("-");h[`${a}-${o}-${C}`]=p.value}else if(e==="Monthly"){const o=f;h[`${a}-${o}`]=p.value}else if(e==="Quarterly"){const o=parseInt(f),C=n.querySelector(`select[data-quarter="${o}"]`);if(C&&C.value){const l=parseInt(C.value),u=[{monthIndices:[0,1,2]},{monthIndices:[3,4,5]},{monthIndices:[6,7,8]},{monthIndices:[9,10,11]}][o].monthIndices.indexOf(l);u!==-1&&(h[`${a}-${o}-${u}`]=p.value)}}}}),h}z&&F&&T&&z.addEventListener("change",n=>{const e=n.target.value;e?(F.style.display="block",X(e,T)):(F.style.display="none",T.innerHTML="")});function ue(){A&&(M&&M.reset(),A.classList.add("open"))}function J(){A&&(A.classList.remove("open"),M&&M.reset(),F&&(F.style.display="none"),T&&(T.innerHTML=""))}R&&R.addEventListener("click",J);j&&j.addEventListener("click",J);A&&A.addEventListener("click",n=>{n.target===A&&J()});M&&M.addEventListener("submit",async n=>{var e,a,h,y,p;if(n.preventDefault(),!!x){x.disabled=!0,x.textContent="Adding...";try{const f=new FormData(M),o=((e=f.get("location"))==null?void 0:e.trim())||"";if(!o){alert("Location is required."),x.disabled=!1,x.textContent="Add Maintenance";return}const l=(((a=f.get("inspectionTasks"))==null?void 0:a.trim())||"").split(`
`).map(d=>d.trim()).filter(d=>d.length>0),t=f.get("frequency")||"",g=((h=T==null?void 0:T.querySelector(".calendar-year-select"))==null?void 0:h.value)||new Date().getFullYear(),u=me(T,t,parseInt(g)),s=[];t==="Weekly"?l.forEach((d,E)=>{for(let r=0;r<12;r++){for(let m=1;m<=4;m++){const v=`${g}-${r}-${m}`;if(u[v]){s[E]=u[v];break}}if(s[E])break}}):t==="Monthly"?l.forEach((d,E)=>{const r=E%12,m=`${g}-${r}`;s[E]=u[m]||""}):t==="Quarterly"&&l.forEach((d,E)=>{const r=Math.floor(E/3),m=E%3,v=`${g}-${r}-${m}`;s[E]=u[v]||""});const c={branch:((y=f.get("branch"))==null?void 0:y.trim())||"",location:o,itemName:((p=f.get("itemName"))==null?void 0:p.trim())||"",frequency:t,inspectionTasks:l,scheduleDates:u,scheduleYear:parseInt(g),taskDates:s,createdAt:new Date().toISOString()};await W(_(N,"maintenance"),c),alert("Maintenance item added successfully!"),J(),await H()}catch(f){console.error("Error adding maintenance item:",f),alert("Failed to add maintenance item. Please try again.")}finally{x&&(x.disabled=!1,x.textContent="Add Maintenance")}}});L&&L.addEventListener("change",async n=>{var y;const e=n.target.files[0];if(!e)return;const a=B.currentUser;if(!a){alert("You must be logged in to upload files. Please log in and try again."),L.value="";return}const h=(S==null?void 0:S.textContent)||"";S&&(S.disabled=!0,S.innerHTML="<span>⏳</span> <span>Processing with AI...</span>");try{const p=await e.arrayBuffer(),f=Y(p,{type:"array",cellStyles:!0}),o=f.SheetNames[0],C=f.Sheets[o],l=[],t=q.decode_range(C["!ref"]||"A1");for(let i=t.s.r;i<=t.e.r;i++)for(let b=t.s.c;b<=t.e.c;b++){const w=q.encode_cell({r:i,c:b}),I=C[w];l.push({address:w,row:i+1,col:b+1,value:I&&I.v!==void 0?String(I.v):"",type:I&&I.t||"s",formatted:I?I.w||String(I.v||""):""})}const g=C["!merges"]||[],u=[],s=t.e.r+1,c=t.e.c+1;for(let i=0;i<s;i++){const b=[];for(let w=0;w<c;w++){const I=q.encode_cell({r:i,c:w}),K=C[I];b.push(K?K.w||String(K.v||""):"")}u.push(b)}if(!u||u.length===0){alert("The file appears to be empty.");return}const d=await a.getIdToken();if(!d)throw new Error("Failed to get authentication token");const E=`https://us-central1-${G.options.projectId}.cloudfunctions.net/extractMaintenanceChecklist`,r=await fetch(E,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${d}`},body:JSON.stringify({excelRows:u,cellData:l,mergedCells:g.map(i=>({s:{r:i.s.r,c:i.s.c},e:{r:i.e.r,c:i.e.c}})),sheetName:o})});if(!r.ok){const i=await r.text();throw new Error(`Function call failed: ${r.status} ${r.statusText} - ${i}`)}const m=await r.json();if(!m.success||!m.items||m.items.length===0){alert("AI could not extract maintenance data from the file. Please check the file format.");return}const v=_(N,"maintenance"),k=m.items.map(i=>{const b={branch:i.branch||"",location:i.location||"",itemName:i.itemName||"",frequency:i.frequency||"Monthly",inspectionTasks:i.inspectionTasks||[],sourceFile:e.name,parsedByAI:!0,createdAt:new Date().toISOString()};return W(v,b)});await Promise.all(k),alert(`Successfully processed and uploaded ${k.length} maintenance items using AI!`),await H()}catch(p){if(console.error("Error importing maintenance file:",p),console.error("Error details:",{code:p.code,message:p.message,currentUser:a?a.uid:"null",hasAuth:!!a,authCurrentUser:B.currentUser?B.currentUser.uid:"null"}),p.code==="functions/unavailable"||p.code==="functions/not-found")alert("AI service is currently unavailable. Please ensure the Cloud Function is deployed.");else if(p.code==="functions/unauthenticated"||(y=p.message)!=null&&y.includes("authenticated"))alert("Authentication error. Please log out and log back in, then try again.");else if(p.message&&p.message.includes("AI")){alert("AI parsing failed. Trying manual parsing...");try{const f=await e.arrayBuffer(),o=Y(f,{type:"array"}),C=o.SheetNames[0],l=o.Sheets[C],t=q.sheet_to_json(l,{header:1,defval:""});if(!t||t.length<=1){alert("The file appears to be empty or missing data rows.");return}const g=t.slice(1),u=_(N,"maintenance"),s=g.filter(c=>c&&c.length>0&&String(c[0]||"").trim()!=="").map(c=>{const E=String(c[4]??"").trim().split(`
`).map(m=>m.trim()).filter(m=>m.length>0),r={branch:String(c[0]??"").trim(),location:String(c[1]??"").trim(),itemName:String(c[2]??"").trim(),frequency:String(c[3]??"").trim(),inspectionTasks:E,sourceFile:e.name,parsedByAI:!1,createdAt:new Date().toISOString()};return W(u,r)});if(s.length===0){alert("No valid data rows found in the file.");return}await Promise.all(s),alert(`Successfully uploaded ${s.length} maintenance items (manual parsing).`),await H()}catch(f){console.error("Fallback parsing also failed:",f),alert("Failed to import file. Please check the format and try again.")}}else alert("Failed to import file: "+(p.message||"Unknown error"))}finally{L.value="",S&&(S.disabled=!1,S.innerHTML=h)}});const U=document.getElementById("sidebar"),V=document.getElementById("sidebar-toggle-btn"),D=document.getElementById("toggle-icon");U&&V&&D&&(localStorage.getItem("sidebarCollapsed")==="true"?(U.classList.add("collapsed"),D.textContent="→"):D.textContent="☰",V.addEventListener("click",e=>{e.stopPropagation(),U.classList.toggle("collapsed"),U.classList.contains("collapsed")?(D.textContent="→",localStorage.setItem("sidebarCollapsed","true")):(D.textContent="☰",localStorage.setItem("sidebarCollapsed","false"))}));document.getElementById("logout-btn").addEventListener("click",async()=>{try{await ne(B),window.location.href="index.html"}catch(n){console.error("Logout error:",n),alert("Error logging out. Please try again.")}});
