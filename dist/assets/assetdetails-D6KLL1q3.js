const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/firebase-firestore-BFWK-5cG.js","assets/firebase-app-D-fiV83C.js","assets/firebase-vendor-B2UDLW_X.js","assets/vendor-BdN5Q6dY.js","assets/firebase-auth-CnPx9bWP.js"])))=>i.map(i=>d[i]);
import{_ as Be,b as oe}from"./qrcode-DEXsfuzH.js";import{H as C,J as Ee}from"./firebase-vendor-B2UDLW_X.js";import{onAuthStateChanged as Ae,signOut as Se}from"./firebase-auth-CnPx9bWP.js";import"./firebase-app-D-fiV83C.js";import{getDoc as ve,doc as U,query as F,collection as Q,limit as $,getDocs as V,updateDoc as Ne,deleteDoc as Te}from"./firebase-firestore-BFWK-5cG.js";import"./vendor-BdN5Q6dY.js";(async()=>{try{const{enableIndexedDbPersistence:t}=await Be(async()=>{const{enableIndexedDbPersistence:o}=await import("./firebase-firestore-BFWK-5cG.js");return{enableIndexedDbPersistence:o}},__vite__mapDeps([0,1,2,3,4]));await t(C),console.log("Firestore persistence enabled")}catch(t){t.code!=="failed-precondition"&&t.code!=="unimplemented"&&console.warn("Persistence setup failed:",t.message)}})();function ke(t){if(t==null||t===void 0)return"";const o=document.createElement("div");return o.textContent=String(t),o.innerHTML}const k=document.getElementById("user-name"),x=document.getElementById("user-avatar"),ae=document.getElementById("asset-id-meta"),O=document.getElementById("asset-status-meta"),I=document.getElementById("asset-spec-list"),se=document.getElementById("summary-asset-id"),ie=document.getElementById("summary-category"),re=document.getElementById("summary-location"),ce=document.getElementById("summary-owner"),le=document.getElementById("qr-code-section"),L=document.getElementById("qr-code-container"),M=document.getElementById("download-qr-btn");let J=null;const R=document.getElementById("asset-actions-btn"),w=document.getElementById("asset-actions-menu"),de=document.getElementById("edit-asset-btn"),me=document.getElementById("delete-asset-btn"),A=document.getElementById("edit-modal-overlay"),ue=document.getElementById("close-modal-btn"),pe=document.getElementById("cancel-edit-btn"),_=document.getElementById("edit-asset-form"),b=document.getElementById("save-edit-btn"),p=document.getElementById("edit-locationDescription"),g=document.getElementById("edit-locationDescription-custom"),D=document.getElementById("toggle-custom-location-edit");let E=null,a=null,B=null,W=0;const Ie=10*60*1e3;Ae(Ee,async t=>{if(t)try{let o=t.email||"User";const n=await ve(U(C,"users",t.uid));if(n.exists()){const e=n.data();o=e.fullName||e.name||t.email||"User"}if(k&&(k.textContent=o),x){const e=o.trim().charAt(0).toUpperCase();x.textContent=e||"U"}}catch(o){console.error("Error loading user data for header:",o);const n=t&&(t.displayName||t.email)||"User";if(k&&(k.textContent=n),x){const e=n.trim().charAt(0).toUpperCase();x.textContent=e||"U"}}});async function be(){const o=new URLSearchParams(window.location.search).get("id");if(!o){I&&(I.innerHTML='<p class="muted">No asset selected.</p>');return}E=o;try{const n=await ve(U(C,"assets",o));if(!n.exists()){I.innerHTML='<p class="muted">Asset not found.</p>';return}const e=n.data();if(ae&&(ae.textContent=e.assetId?`Asset ID: ${e.assetId} • Serial: ${e.serialNo||"N/A"}`:`Asset document ID: ${o}`),O){const l=e.status||"";if(l){const d=String(l).toLowerCase()==="active",m=ke(l);O.innerHTML=d?`Status: <span class="status-active">${m}</span>`:`Status: ${m}`}else O.textContent=""}se&&(se.textContent=e.assetId||"Not set"),ie&&(ie.textContent=e.assetCategoryDescription||e.assetCategory||"Not set"),re&&(re.textContent=e.locationDescription||e.location||"Not set"),ce&&(ce.textContent=e.ownerName||e.ownerCode||"Not set"),a=e;const c=[{label:"Branch Code",value:e.branchCode},{label:"Asset Description",value:e.assetDescription},{label:"Asset Category",value:e.assetCategory},{label:"Asset Category Description",value:e.assetCategoryDescription},{label:"Owner Code",value:e.ownerCode},{label:"Owner Name",value:e.ownerName},{label:"Model",value:e.model},{label:"Brand",value:e.brand},{label:"Warranty Period",value:e.warrantyPeriod},{label:"Location",value:e.location},{label:"Location Description",value:e.locationDescription},{label:"Area",value:e.area},{label:"Department Code",value:e.departmentCode},{label:"Department Description",value:e.departmentDescription},{label:"Condition",value:e.condition},{label:"Current User",value:e.currentUser}];I.innerHTML="",c.forEach(l=>{const d=document.createElement("div");d.className="spec-row";const m=document.createElement("div");m.className="spec-label",m.textContent=l.label;const i=document.createElement("div");if(i.className="spec-value",l.value)i.textContent=l.value;else{const r=document.createElement("span");r.className="muted",r.textContent="Not set",i.appendChild(r)}d.appendChild(m),d.appendChild(i),I.appendChild(d)}),await xe(e)}catch(n){console.error("Error loading asset details:",n),I.innerHTML='<p class="muted">Failed to load asset details. Please refresh.</p>'}}async function xe(t){if(!(!L||!le))try{const o={assetId:t.assetId||E,assetDescription:t.assetDescription||"",assetCategory:t.assetCategoryDescription||t.assetCategory||"",serialNo:t.serialNo||"",location:t.locationDescription||t.location||"",status:t.status||"",timestamp:new Date().toISOString()},n=JSON.stringify(o);L.innerHTML="";const e=await oe.toDataURL(n,{width:300,margin:2,color:{dark:"#140958",light:"#ffffff"}});J=await oe.toDataURL(n,{width:150,margin:2,color:{dark:"#140958",light:"#ffffff"}});const c=document.createElement("img");c.src=e,c.alt="Asset QR Code",c.style.display="block",c.style.margin="0 auto",L.appendChild(c),M&&(M.style.display="inline-flex"),le.style.display="block"}catch(o){console.error("Error generating QR code:",o),L&&(L.innerHTML='<p class="muted">Failed to generate QR code.</p>')}}M&&M.addEventListener("click",()=>{if(!J){alert("QR code not available for download.");return}const o=`QR_Code_${(a==null?void 0:a.assetId)||E||"asset"}_${new Date().toISOString().split("T")[0]}.png`,n=document.createElement("a");n.href=J,n.download=o,document.body.appendChild(n),n.click(),document.body.removeChild(n)});be();R&&w&&(R.addEventListener("click",t=>{t.stopPropagation(),w.classList.toggle("open")}),document.addEventListener("click",t=>{!R.contains(t.target)&&!w.contains(t.target)&&w.classList.remove("open")}));async function Me(){if(!p)return;const t=Date.now();if(B&&t-W<Ie){ge(B),ye();return}p.innerHTML='<option value="">Loading locations...</option>';try{const o=performance.now(),n=new Set,e=F(Q(C,"maintenance"),$(100)),c=F(Q(C,"assets"),$(500)),[l,d]=await Promise.all([V(e).catch(i=>(console.error("Error loading maintenance:",i),{docs:[],empty:!0,forEach:()=>{}})),V(c).catch(i=>(console.error("Error loading assets:",i),{docs:[],empty:!0,forEach:()=>{}}))]);l.forEach(i=>{const r=i.data();(Array.isArray(r.inspectionTasks)?r.inspectionTasks:typeof r.inspectionTasks=="string"?r.inspectionTasks.split(`
`).filter(y=>y.trim()):[]).forEach(y=>{y&&y.trim()!==""&&n.add(y.trim())})}),d.forEach(i=>{const r=i.data();r.locationDescription&&r.locationDescription.trim()!==""&&n.add(r.locationDescription.trim())});const m=performance.now()-o;console.log(`Loaded ${n.size} locations in ${m.toFixed(2)}ms`),B=Array.from(n).sort(),W=t,ge(B),ye()}catch(o){console.error("Error loading locations:",o),p.innerHTML='<option value="">Error loading locations</option>'}}function ge(t){p&&(p.innerHTML='<option value="">Select location...</option>',t.forEach(o=>{const n=document.createElement("option");n.value=o,n.textContent=o,p.appendChild(n)}))}function ye(){!a||!p||a.locationDescription&&(p.value=a.locationDescription,!p.value&&a.locationDescription&&(g&&(g.style.display="block",g.value=a.locationDescription),D&&(D.textContent="Use dropdown")))}D&&g&&D.addEventListener("click",()=>{g.style.display==="none"?(g.style.display="block",D.textContent="Use dropdown",p&&(p.value="")):(g.style.display="none",g.value="",D.textContent="+ Add custom location")});de&&de.addEventListener("click",()=>{w.classList.remove("open"),Ue()});function Ue(){if(!a||!E){alert("Asset data not loaded.");return}Me(),document.getElementById("edit-no").value=a.no||"",document.getElementById("edit-branchCode").value=a.branchCode||"",document.getElementById("edit-assetId").value=a.assetId||"",document.getElementById("edit-assetDescription").value=a.assetDescription||"",document.getElementById("edit-assetCategory").value=a.assetCategory||"",document.getElementById("edit-assetCategoryDescription").value=a.assetCategoryDescription||"",document.getElementById("edit-ownerCode").value=a.ownerCode||"",document.getElementById("edit-ownerName").value=a.ownerName||"",document.getElementById("edit-model").value=a.model||"",document.getElementById("edit-brand").value=a.brand||"",document.getElementById("edit-status").value=a.status||"Active",document.getElementById("edit-warrantyPeriod").value=a.warrantyPeriod||"",document.getElementById("edit-serialNo").value=a.serialNo||"",document.getElementById("edit-location").value=a.location||"",document.getElementById("edit-area").value=a.area||"",document.getElementById("edit-departmentCode").value=a.departmentCode||"",document.getElementById("edit-departmentDescription").value=a.departmentDescription||"",document.getElementById("edit-condition").value=a.condition||"",document.getElementById("edit-currentUser").value=a.currentUser||"",A.classList.add("open")}function P(){A.classList.remove("open")}ue&&ue.addEventListener("click",P);pe&&pe.addEventListener("click",P);A&&A.addEventListener("click",t=>{t.target===A&&P()});_&&_.addEventListener("submit",async t=>{var o,n,e,c,l,d,m,i,r,q,y,j,z,G,K,X,Y,Z,ee;if(t.preventDefault(),!E){alert("No asset selected.");return}b.disabled=!0,b.textContent="Saving...";try{const s=new FormData(_),te=((o=s.get("assetId"))==null?void 0:o.trim())||"";if(!te){alert("Asset ID is required and cannot be blank."),b.disabled=!1,b.textContent="Save Changes";return}let S=g&&g.style.display!=="none"?((n=s.get("locationDescriptionCustom"))==null?void 0:n.trim())||"":((e=s.get("locationDescription"))==null?void 0:e.trim())||"";if(S){const v=S.toLowerCase().trim(),we=Date.now();let ne=!1;B&&we-W<Ie;try{const H=F(Q(C,"maintenance"),$(100)),De=await V(H);for(const he of De.docs){const T=he.data(),Le=Array.isArray(T.inspectionTasks)?T.inspectionTasks:typeof T.inspectionTasks=="string"?T.inspectionTasks.split(`
`).filter(h=>h.trim()):[];for(const h of Le)if(h&&h.trim().toLowerCase()===v){S=h.trim(),ne=!0;break}if(ne)break}}catch(H){console.warn("Error loading maintenance for location matching:",H)}}const N={no:((c=s.get("no"))==null?void 0:c.trim())||"",branchCode:((l=s.get("branchCode"))==null?void 0:l.trim())||"",assetId:te,assetDescription:((d=s.get("assetDescription"))==null?void 0:d.trim())||"",assetCategory:((m=s.get("assetCategory"))==null?void 0:m.trim())||"",assetCategoryDescription:((i=s.get("assetCategoryDescription"))==null?void 0:i.trim())||"",ownerCode:((r=s.get("ownerCode"))==null?void 0:r.trim())||"",ownerName:((q=s.get("ownerName"))==null?void 0:q.trim())||"",model:((y=s.get("model"))==null?void 0:y.trim())||"",brand:((j=s.get("brand"))==null?void 0:j.trim())||"",status:s.get("status")||"Active",warrantyPeriod:((z=s.get("warrantyPeriod"))==null?void 0:z.trim())||"",serialNo:((G=s.get("serialNo"))==null?void 0:G.trim())||"",location:((K=s.get("location"))==null?void 0:K.trim())||"",locationDescription:S,area:((X=s.get("area"))==null?void 0:X.trim())||"",departmentCode:((Y=s.get("departmentCode"))==null?void 0:Y.trim())||"",departmentDescription:((Z=s.get("departmentDescription"))==null?void 0:Z.trim())||"",condition:s.get("condition")||"",currentUser:((ee=s.get("currentUser"))==null?void 0:ee.trim())||"",updatedAt:new Date().toISOString()};Object.keys(N).forEach(v=>{v!=="updatedAt"&&v!=="assetId"&&N[v]===""&&delete N[v]}),await Ne(U(C,"assets",E),N),alert("Asset updated successfully!"),P(),be()}catch(s){console.error("Error updating asset:",s),alert("Failed to update asset. Please try again.")}finally{b.disabled=!1,b.textContent="Save Changes"}});me&&me.addEventListener("click",async()=>{if(w.classList.remove("open"),!E){alert("No asset selected.");return}if(!(!confirm(`Are you sure you want to delete this asset?

This action cannot be undone and the asset will be permanently removed from the database.`)||!confirm(`⚠️ WARNING: This will permanently delete the asset from the database.

Click OK to confirm deletion.`)))try{await Te(U(C,"assets",E)),alert("Asset deleted successfully!"),window.location.replace("/assets/asset.html")}catch(n){console.error("Error deleting asset:",n),alert("Failed to delete asset. Please try again.")}});const fe=document.getElementById("logout-btn");fe&&fe.addEventListener("click",async()=>{try{await Se(Ee),window.location.replace("/index.html")}catch(t){console.error("Logout error:",t),alert("Error logging out. Please try again.")}});const f=document.getElementById("sidebar"),Ce=document.getElementById("sidebar-toggle-btn"),u=document.getElementById("toggle-icon");if(f&&Ce&&u){localStorage.getItem("sidebarCollapsed")==="true"?(f.classList.add("collapsed"),u.textContent="→"):u.textContent="☰",Ce.addEventListener("click",n=>{n.stopPropagation(),n.preventDefault(),f.classList.contains("collapsed"),u.style.opacity="0",u.style.transform="scale(0.8)",setTimeout(()=>{f.classList.toggle("collapsed"),f.classList.contains("collapsed")?u.textContent="→":u.textContent="☰",setTimeout(()=>{u.style.opacity="1",u.style.transform="scale(1)"},50);const e=document.querySelector(".app-shell");e&&(f.classList.contains("collapsed")?e.classList.add("has-collapsed-sidebar"):e.classList.remove("has-collapsed-sidebar")),localStorage.setItem("sidebarCollapsed",f.classList.contains("collapsed")?"true":"false")},150)});const o=document.querySelector(".app-shell");o&&f.classList.contains("collapsed")&&o.classList.add("has-collapsed-sidebar"),u.style.opacity="1",u.style.transform="scale(1)"}
