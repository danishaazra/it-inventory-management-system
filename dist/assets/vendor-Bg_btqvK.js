const B=(e,n)=>n.some(t=>e instanceof t);let b,D;function M(){return b||(b=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function g(){return D||(D=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const I=new WeakMap,l=new WeakMap,E=new WeakMap,d=new WeakMap,m=new WeakMap;function L(e){const n=new Promise((t,r)=>{const o=()=>{e.removeEventListener("success",c),e.removeEventListener("error",s)},c=()=>{t(a(e.result)),o()},s=()=>{r(e.error),o()};e.addEventListener("success",c),e.addEventListener("error",s)});return n.then(t=>{t instanceof IDBCursor&&I.set(t,e)}).catch(()=>{}),m.set(n,e),n}function S(e){if(l.has(e))return;const n=new Promise((t,r)=>{const o=()=>{e.removeEventListener("complete",c),e.removeEventListener("error",s),e.removeEventListener("abort",s)},c=()=>{t(),o()},s=()=>{r(e.error||new DOMException("AbortError","AbortError")),o()};e.addEventListener("complete",c),e.addEventListener("error",s),e.addEventListener("abort",s)});l.set(e,n)}let h={get(e,n,t){if(e instanceof IDBTransaction){if(n==="done")return l.get(e);if(n==="objectStoreNames")return e.objectStoreNames||E.get(e);if(n==="store")return t.objectStoreNames[1]?void 0:t.objectStore(t.objectStoreNames[0])}return a(e[n])},set(e,n,t){return e[n]=t,!0},has(e,n){return e instanceof IDBTransaction&&(n==="done"||n==="store")?!0:n in e}};function O(e){h=e(h)}function P(e){return e===IDBDatabase.prototype.transaction&&!("objectStoreNames"in IDBTransaction.prototype)?function(n,...t){const r=e.call(p(this),n,...t);return E.set(r,n.sort?n.sort():[n]),a(r)}:g().includes(e)?function(...n){return e.apply(p(this),n),a(I.get(this))}:function(...n){return a(e.apply(p(this),n))}}function j(e){return typeof e=="function"?P(e):(e instanceof IDBTransaction&&S(e),B(e,M())?new Proxy(e,h):e)}function a(e){if(e instanceof IDBRequest)return L(e);if(d.has(e))return d.get(e);const n=j(e);return n!==e&&(d.set(e,n),m.set(n,e)),n}const p=e=>m.get(e);function x(e,n,{blocked:t,upgrade:r,blocking:o,terminated:c}={}){const s=indexedDB.open(e,n),f=a(s);return r&&s.addEventListener("upgradeneeded",i=>{r(a(s.result),i.oldVersion,i.newVersion,a(s.transaction),i)}),t&&s.addEventListener("blocked",i=>t(i.oldVersion,i.newVersion,i)),f.then(i=>{c&&i.addEventListener("close",()=>c()),o&&i.addEventListener("versionchange",u=>o(u.oldVersion,u.newVersion,u))}).catch(()=>{}),f}const C=["get","getKey","getAll","getAllKeys","count"],T=["put","add","delete","clear"],y=new Map;function w(e,n){if(!(e instanceof IDBDatabase&&!(n in e)&&typeof n=="string"))return;if(y.get(n))return y.get(n);const t=n.replace(/FromIndex$/,""),r=n!==t,o=T.includes(t);if(!(t in(r?IDBIndex:IDBObjectStore).prototype)||!(o||C.includes(t)))return;const c=async function(s,...f){const i=this.transaction(s,o?"readwrite":"readonly");let u=i.store;return r&&(u=u.index(f.shift())),(await Promise.all([u[t](...f),o&&i.done]))[0]};return y.set(n,c),c}O(e=>({...e,get:(n,t,r)=>w(n,t)||e.get(n,t,r),has:(n,t)=>!!w(n,t)||e.has(n,t)}));function V(e,n){var t={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&n.indexOf(r)<0&&(t[r]=e[r]);if(e!=null&&typeof Object.getOwnPropertySymbols=="function")for(var o=0,r=Object.getOwnPropertySymbols(e);o<r.length;o++)n.indexOf(r[o])<0&&Object.prototype.propertyIsEnumerable.call(e,r[o])&&(t[r[o]]=e[r[o]]);return t}export{V as _,x as o};
