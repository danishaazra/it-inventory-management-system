import"./qrcode-_3APf9r8.js";import{H as x,J as oe}from"./firebase-vendor-BDhSju_T.js";import{o as le,s as de}from"./firebase-auth-V8RQ8eEz.js";import"./firebase-app-CdRXrjY0.js";import{getDoc as M,doc as N,collection as ce,getDocs as re,updateDoc as ie}from"./firebase-firestore-DyzXcozE.js";import"./vendor-BdN5Q6dY.js";const _=document.getElementById("user-name"),z=document.getElementById("user-avatar"),G=document.getElementById("back-link"),L=document.getElementById("assets-remaining"),E=document.getElementById("days-remaining"),f=document.getElementById("assets-list"),K=document.getElementById("page-title"),X=document.getElementById("add-asset-btn"),D=document.getElementById("add-asset-modal-overlay"),Z=document.getElementById("close-add-asset-modal-btn"),ee=document.getElementById("cancel-add-asset-btn"),te=document.getElementById("save-add-asset-btn"),P=document.getElementById("asset-select-list"),A=document.getElementById("inspection-modal-overlay"),ne=document.getElementById("close-inspection-modal-btn"),se=document.getElementById("cancel-inspection-btn"),B=document.getElementById("save-inspection-btn"),T=document.getElementById("inspection-form"),F=document.getElementById("inspection-notes");let k=null,g=null,me=null,V=[],O=null;le(oe,async t=>{if(t)try{let s=t.email||"User";const o=await M(N(x,"users",t.uid));if(o.exists()){const e=o.data();s=e.fullName||e.name||t.email||"User"}if(_&&(_.textContent=s),z){const e=s.trim().charAt(0).toUpperCase();z.textContent=e||"U"}await pe()}catch(s){console.error("Error loading user data:",s)}});async function pe(){const t=new URLSearchParams(window.location.search),s=t.get("maintenanceId"),o=parseInt(t.get("taskIndex")||"0");if(!s){alert("No maintenance item ID provided."),window.location.href="maintenance.html";return}k=s,g=o;try{const e=await M(N(x,"maintenance",s));if(!e.exists()){alert("Maintenance item not found."),window.location.href="maintenance.html";return}const d=e.data();me=d,G&&(G.href=`inspectiontask.html?id=${encodeURIComponent(s)}`);const m=Array.isArray(d.inspectionTasks)?d.inspectionTasks:typeof d.inspectionTasks=="string"?d.inspectionTasks.split(`
`).filter(c=>c.trim()):[];m[o]&&K&&(K.textContent=m[o]);let u=(d.taskDates||[])[o]||"";if(u){const c=new Date(u),l=new Date;l.setHours(0,0,0,0);const a=new Date(c.getFullYear(),c.getMonth(),c.getDate());let p=Math.ceil((a-l)/(1e3*60*60*24)),n=c;const y=d.frequency||"Monthly";if(p<0){if(y==="Weekly")for(;n<=l;)n=new Date(n.getTime()+7*24*60*60*1e3);else if(y==="Monthly")for(;n<=l;)n=new Date(n.getFullYear(),n.getMonth()+1,n.getDate());else if(y==="Quarterly")for(;n<=l;)n=new Date(n.getFullYear(),n.getMonth()+3,n.getDate());const v=new Date(n.getFullYear(),n.getMonth(),n.getDate());p=Math.ceil((v-l)/(1e3*60*60*24))}E&&(p===0?(E.textContent="Today",E.style.color="#dc2626"):p===1?(E.textContent="Tomorrow",E.style.color="#92400e"):(E.textContent=`${p} days remaining`,E.style.color="#140958"))}else E&&(E.textContent="Not scheduled",E.style.color="#6b7280");await Y()}catch(e){console.error("Error loading inspection assets:",e),alert("Failed to load inspection assets. Please try again."),window.location.href="maintenance.html"}}async function Y(){if(!k||g===null){f&&(f.innerHTML='<div class="no-assets">No maintenance item or task specified.</div>'),L&&(L.textContent="0");return}try{const t=await M(N(x,"maintenance",k));if(!t.exists()){f&&(f.innerHTML='<div class="no-assets">Maintenance item not found.</div>');return}const s=t.data(),e=(s.inspectionTaskAssets||{})[g]||[],m=(s.inspectionData||{})[g]||{};if(V=e,e.length===0){f&&(f.innerHTML='<div class="no-assets">No assets assigned to this inspection task. Click "Add Asset" to select assets.</div>'),L&&(L.textContent="0");return}const b=ce(x,"assets"),u=e.map(a=>M(N(b,a))),c=await Promise.all(u),l=[];if(c.forEach((a,p)=>{if(a.exists()){const n=e[p],y=m[n]||null;l.push({id:n,...a.data(),inspection:y})}}),L&&(L.textContent=l.length),f)if(f.innerHTML="",l.length===0){const a=document.createElement("div");a.className="no-assets",a.style.padding="2rem",a.style.textAlign="center",a.innerHTML='No assets assigned. Click "Add Asset" to select assets.',f.appendChild(a)}else{const a=document.createElement("table");a.className="assets-table";const p=document.createElement("thead"),n=document.createElement("tr");["ID","Asset Name","Category","Status","Action","View More"].forEach(i=>{const r=document.createElement("th");r.textContent=i,n.appendChild(r)}),p.appendChild(n),a.appendChild(p);const v=document.createElement("tbody");l.forEach(i=>{const r=document.createElement("tr"),C=document.createElement("td");C.className="asset-id",C.textContent=i.assetId||i.id,r.appendChild(C);const w=document.createElement("td");w.className="asset-name",w.textContent=i.assetDescription||i.assetName||"N/A",r.appendChild(w);const q=document.createElement("td");q.className="asset-category",q.textContent=i.assetCategoryDescription||i.assetCategory||"N/A",r.appendChild(q);const j=document.createElement("td"),S=document.createElement("span");i.inspection&&i.inspection.solved==="yes"?(S.className="status-badge status-complete",S.textContent="Complete"):(S.className="status-badge status-open",S.textContent="Open"),j.appendChild(S),r.appendChild(j);const J=document.createElement("td"),R=document.createElement("button");R.className="btn-inspect",R.textContent="Inspect",R.addEventListener("click",async W=>{W.preventDefault(),W.stopPropagation(),await he(i.id,i.inspection)}),J.appendChild(R),r.appendChild(J);const Q=document.createElement("td"),H=document.createElement("a");H.href=`inspectionassetdetails.html?maintenanceId=${encodeURIComponent(k)}&taskIndex=${g}&assetId=${encodeURIComponent(i.id)}`,H.className="btn-view-more-asset",H.textContent="View More",Q.appendChild(H),r.appendChild(Q),v.appendChild(r)}),a.appendChild(v),f.appendChild(a)}}catch(t){console.error("Error loading assets:",t),f&&(f.innerHTML='<div class="no-assets">Failed to load assets. Please try again.</div>')}}async function ue(){if(D)try{const t=ce(x,"assets"),s=await re(t),o=[];if(s.forEach(e=>{o.push({id:e.id,...e.data()})}),P)if(P.innerHTML="",o.length===0){const e=document.createElement("div");e.className="no-assets",e.style.padding="2rem",e.style.textAlign="center",e.textContent="No assets registered yet.",P.appendChild(e)}else{const e=document.createElement("table");e.className="asset-select-table";const d=document.createElement("thead"),m=document.createElement("tr");["Action","ID","Asset Name","Category","View More"].forEach(c=>{const l=document.createElement("th");l.textContent=c,m.appendChild(l)}),d.appendChild(m),e.appendChild(d);const u=document.createElement("tbody");o.forEach(c=>{const l=V.includes(c.id),a=document.createElement("tr"),p=document.createElement("td"),n=document.createElement("input");n.type="checkbox",n.className="asset-select-checkbox",n.value=c.id,n.checked=l,n.id=`asset-${c.id}`,p.appendChild(n),a.appendChild(p);const y=document.createElement("td");y.className="asset-select-id",y.textContent=c.assetId||c.id,a.appendChild(y);const v=document.createElement("td");v.className="asset-select-name",v.textContent=c.assetDescription||c.assetName||"N/A",a.appendChild(v);const i=document.createElement("td");i.className="asset-select-category",i.textContent=c.assetCategoryDescription||c.assetCategory||"N/A",a.appendChild(i);const r=document.createElement("td"),C=document.createElement("a");C.href=`assetdetails.html?id=${encodeURIComponent(c.id)}`,C.target="_blank",C.className="btn-view-more",C.textContent="View More",r.appendChild(C),a.appendChild(r),a.addEventListener("click",w=>{w.target!==n&&w.target!==C&&w.target!==r&&(n.checked=!n.checked)}),u.appendChild(a)}),e.appendChild(u),P.appendChild(e)}D.classList.add("open")}catch(t){console.error("Error loading assets for selection:",t),alert("Failed to load assets. Please try again.")}}function U(){D&&D.classList.remove("open")}async function fe(){if(!(!k||g===null))try{const t=P.querySelectorAll('input[type="checkbox"]:checked'),s=Array.from(t).map(b=>b.value),o=N(x,"maintenance",k),e=await M(o);if(!e.exists()){alert("Maintenance item not found.");return}const m=e.data().inspectionTaskAssets||{};m[g]=s,await ie(o,{inspectionTaskAssets:m}),V=s,U(),await Y(),alert(`Successfully added ${s.length} asset(s) to this inspection task.`)}catch(t){console.error("Error saving selected assets:",t),alert("Failed to save selected assets. Please try again.")}}X&&X.addEventListener("click",ue);Z&&Z.addEventListener("click",U);ee&&ee.addEventListener("click",U);te&&te.addEventListener("click",fe);D&&D.addEventListener("click",t=>{t.target===D&&U()});async function he(t,s){A&&(O=t,s?(F&&(F.value=s.notes||""),s.solved==="yes"?document.getElementById("solved-yes").checked=!0:document.getElementById("solved-no").checked=!0):T&&T.reset(),A.classList.add("open"))}function $(){A&&(A.classList.remove("open"),T&&T.reset(),O=null)}async function ge(){var t,s;if(!(!k||g===null||!O))try{const o=((t=F==null?void 0:F.value)==null?void 0:t.trim())||"",e=((s=document.querySelector('input[name="solved"]:checked'))==null?void 0:s.value)||"";if(!o){alert("Please enter inspection notes.");return}if(!e){alert("Please select if the issue is solved or not.");return}const d=N(x,"maintenance",k),m=await M(d);if(!m.exists()){alert("Maintenance item not found.");return}const u=m.data().inspectionData||{};u[g]||(u[g]={}),u[g][O]={notes:o,solved:e,timestamp:new Date().toISOString(),updatedAt:new Date().toISOString()},await ie(d,{inspectionData:u}),$(),await Y(),alert("Inspection saved successfully.")}catch(o){console.error("Error saving inspection:",o),alert("Failed to save inspection. Please try again.")}}ne&&ne.addEventListener("click",$);se&&se.addEventListener("click",$);T&&T.addEventListener("submit",async t=>{t.preventDefault(),B&&(B.disabled=!0,B.textContent="Saving..."),await ge(),B&&(B.disabled=!1,B.textContent="Save Inspection")});A&&A.addEventListener("click",t=>{t.target===A&&$()});document.getElementById("logout-btn").addEventListener("click",async()=>{try{await de(oe),window.location.href="index.html"}catch(t){console.error("Logout error:",t),alert("Error logging out. Please try again.")}});const I=document.getElementById("sidebar"),ae=document.getElementById("sidebar-toggle-btn"),h=document.getElementById("toggle-icon");if(I&&ae&&h){localStorage.getItem("sidebarCollapsed")==="true"?(I.classList.add("collapsed"),h.textContent="→"):h.textContent="☰",ae.addEventListener("click",o=>{o.stopPropagation(),o.preventDefault(),I.classList.contains("collapsed"),h.style.opacity="0",h.style.transform="scale(0.8)",setTimeout(()=>{I.classList.toggle("collapsed"),I.classList.contains("collapsed")?h.textContent="→":h.textContent="☰",setTimeout(()=>{h.style.opacity="1",h.style.transform="scale(1)"},50);const e=document.querySelector(".app-shell");e&&(I.classList.contains("collapsed")?e.classList.add("has-collapsed-sidebar"):e.classList.remove("has-collapsed-sidebar")),localStorage.setItem("sidebarCollapsed",I.classList.contains("collapsed")?"true":"false")},150)});const s=document.querySelector(".app-shell");s&&I.classList.contains("collapsed")&&s.classList.add("has-collapsed-sidebar"),h.style.opacity="1",h.style.transform="scale(1)"}
