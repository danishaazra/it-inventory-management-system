import"./qrcode-DEXsfuzH.js";import{H as A,J as ae}from"./firebase-vendor-B2UDLW_X.js";import{onAuthStateChanged as oe}from"./firebase-auth-CnPx9bWP.js";import"./firebase-app-D-fiV83C.js";import{getDoc as M,doc as B,collection as ne,getDocs as ce,updateDoc as se}from"./firebase-firestore-BFWK-5cG.js";import"./vendor-BdN5Q6dY.js";const Q=document.getElementById("user-name"),W=document.getElementById("user-avatar"),_=document.getElementById("back-link"),x=document.getElementById("assets-remaining"),C=document.getElementById("days-remaining"),f=document.getElementById("assets-list"),z=document.getElementById("page-title"),G=document.getElementById("add-asset-btn"),k=document.getElementById("add-asset-modal-overlay"),K=document.getElementById("close-add-asset-modal-btn"),X=document.getElementById("cancel-add-asset-btn"),Z=document.getElementById("save-add-asset-btn"),T=document.getElementById("asset-select-list"),w=document.getElementById("inspection-modal-overlay"),ee=document.getElementById("close-inspection-modal-btn"),te=document.getElementById("cancel-inspection-btn"),b=document.getElementById("save-inspection-btn"),N=document.getElementById("inspection-form"),S=document.getElementById("inspection-notes");let v=null,h=null,ie=null,$=[],R=null;oe(ae,async n=>{if(n)try{let s=n.email||"User";const c=await M(B(A,"users",n.uid));if(c.exists()){const e=c.data();s=e.fullName||e.name||n.email||"User"}if(Q&&(Q.textContent=s),W){const e=s.trim().charAt(0).toUpperCase();W.textContent=e||"U"}await le()}catch(s){console.error("Error loading user data:",s)}});async function le(){const n=new URLSearchParams(window.location.search),s=n.get("maintenanceId"),c=parseInt(n.get("taskIndex")||"0");if(!s){alert("No maintenance item ID provided."),window.location.replace("/maintenance/maintenance.html");return}v=s,h=c;try{const e=await M(B(A,"maintenance",s));if(!e.exists()){alert("Maintenance item not found."),window.location.replace("/maintenance/maintenance.html");return}const d=e.data();ie=d,_&&(_.href=`/inspection/inspectiontask.html?id=${encodeURIComponent(s)}`);const m=Array.isArray(d.inspectionTasks)?d.inspectionTasks:typeof d.inspectionTasks=="string"?d.inspectionTasks.split(`
`).filter(o=>o.trim()):[];m[c]&&z&&(z.textContent=m[c]);let u=(d.taskDates||[])[c]||"";if(u){const o=new Date(u),l=new Date;l.setHours(0,0,0,0);const a=new Date(o.getFullYear(),o.getMonth(),o.getDate());let p=Math.ceil((a-l)/(1e3*60*60*24)),t=o;const y=d.frequency||"Monthly";if(p<0){if(y==="Weekly")for(;t<=l;)t=new Date(t.getTime()+7*24*60*60*1e3);else if(y==="Monthly")for(;t<=l;)t=new Date(t.getFullYear(),t.getMonth()+1,t.getDate());else if(y==="Quarterly")for(;t<=l;)t=new Date(t.getFullYear(),t.getMonth()+3,t.getDate());const E=new Date(t.getFullYear(),t.getMonth(),t.getDate());p=Math.ceil((E-l)/(1e3*60*60*24))}C&&(p===0?(C.textContent="Today",C.style.color="#dc2626"):p===1?(C.textContent="Tomorrow",C.style.color="#92400e"):(C.textContent=`${p} days remaining`,C.style.color="#140958"))}else C&&(C.textContent="Not scheduled",C.style.color="#6b7280");await V()}catch(e){console.error("Error loading inspection assets:",e),alert("Failed to load inspection assets. Please try again."),window.location.replace("/maintenance/maintenance.html")}}async function V(){if(!v||h===null){f&&(f.innerHTML='<div class="no-assets">No maintenance item or task specified.</div>'),x&&(x.textContent="0");return}try{const n=await M(B(A,"maintenance",v));if(!n.exists()){f&&(f.innerHTML='<div class="no-assets">Maintenance item not found.</div>');return}const s=n.data(),e=(s.inspectionTaskAssets||{})[h]||[],m=(s.inspectionData||{})[h]||{};if($=e,e.length===0){f&&(f.innerHTML='<div class="no-assets">No assets assigned to this inspection task. Click "Add Asset" to select assets.</div>'),x&&(x.textContent="0");return}const D=ne(A,"assets"),u=e.map(a=>M(B(D,a))),o=await Promise.all(u),l=[];if(o.forEach((a,p)=>{if(a.exists()){const t=e[p],y=m[t]||null;l.push({id:t,...a.data(),inspection:y})}}),x&&(x.textContent=l.length),f)if(f.innerHTML="",l.length===0){const a=document.createElement("div");a.className="no-assets",a.style.padding="2rem",a.style.textAlign="center",a.innerHTML='No assets assigned. Click "Add Asset" to select assets.',f.appendChild(a)}else{const a=document.createElement("table");a.className="assets-table";const p=document.createElement("thead"),t=document.createElement("tr");["ID","Asset Name","Category","Status","Action","View More"].forEach(i=>{const r=document.createElement("th");r.textContent=i,t.appendChild(r)}),p.appendChild(t),a.appendChild(p);const E=document.createElement("tbody");l.forEach(i=>{const r=document.createElement("tr"),g=document.createElement("td");g.className="asset-id",g.textContent=i.assetId||i.id,r.appendChild(g);const I=document.createElement("td");I.className="asset-name",I.textContent=i.assetDescription||i.assetName||"N/A",r.appendChild(I);const O=document.createElement("td");O.className="asset-category",O.textContent=i.assetCategoryDescription||i.assetCategory||"N/A",r.appendChild(O);const q=document.createElement("td"),L=document.createElement("span");i.inspection&&i.inspection.solved==="yes"?(L.className="status-badge status-complete",L.textContent="Complete"):(L.className="status-badge status-open",L.textContent="Open"),q.appendChild(L),r.appendChild(q);const Y=document.createElement("td"),P=document.createElement("button");P.className="btn-inspect",P.textContent="Inspect",P.addEventListener("click",async J=>{J.preventDefault(),J.stopPropagation(),await me(i.id,i.inspection)}),Y.appendChild(P),r.appendChild(Y);const j=document.createElement("td"),F=document.createElement("a");F.href=`/inspection/inspectionassetdetails.html?maintenanceId=${encodeURIComponent(v)}&taskIndex=${h}&assetId=${encodeURIComponent(i.id)}`,F.className="btn-view-more-asset",F.textContent="View More",j.appendChild(F),r.appendChild(j),E.appendChild(r)}),a.appendChild(E),f.appendChild(a)}}catch(n){console.error("Error loading assets:",n),f&&(f.innerHTML='<div class="no-assets">Failed to load assets. Please try again.</div>')}}async function de(){if(k)try{const n=ne(A,"assets"),s=await ce(n),c=[];if(s.forEach(e=>{c.push({id:e.id,...e.data()})}),T)if(T.innerHTML="",c.length===0){const e=document.createElement("div");e.className="no-assets",e.style.padding="2rem",e.style.textAlign="center",e.textContent="No assets registered yet.",T.appendChild(e)}else{const e=document.createElement("table");e.className="asset-select-table";const d=document.createElement("thead"),m=document.createElement("tr");["Action","ID","Asset Name","Category","View More"].forEach(o=>{const l=document.createElement("th");l.textContent=o,m.appendChild(l)}),d.appendChild(m),e.appendChild(d);const u=document.createElement("tbody");c.forEach(o=>{const l=$.includes(o.id),a=document.createElement("tr"),p=document.createElement("td"),t=document.createElement("input");t.type="checkbox",t.className="asset-select-checkbox",t.value=o.id,t.checked=l,t.id=`asset-${o.id}`,p.appendChild(t),a.appendChild(p);const y=document.createElement("td");y.className="asset-select-id",y.textContent=o.assetId||o.id,a.appendChild(y);const E=document.createElement("td");E.className="asset-select-name",E.textContent=o.assetDescription||o.assetName||"N/A",a.appendChild(E);const i=document.createElement("td");i.className="asset-select-category",i.textContent=o.assetCategoryDescription||o.assetCategory||"N/A",a.appendChild(i);const r=document.createElement("td"),g=document.createElement("a");g.href=`../assets/assetdetails.html?id=${encodeURIComponent(o.id)}`,g.target="_blank",g.className="btn-view-more",g.textContent="View More",r.appendChild(g),a.appendChild(r),a.addEventListener("click",I=>{I.target!==t&&I.target!==g&&I.target!==r&&(t.checked=!t.checked)}),u.appendChild(a)}),e.appendChild(u),T.appendChild(e)}k.classList.add("open")}catch(n){console.error("Error loading assets for selection:",n),alert("Failed to load assets. Please try again.")}}function H(){k&&k.classList.remove("open")}async function re(){if(!(!v||h===null))try{const n=T.querySelectorAll('input[type="checkbox"]:checked'),s=Array.from(n).map(D=>D.value),c=B(A,"maintenance",v),e=await M(c);if(!e.exists()){alert("Maintenance item not found.");return}const m=e.data().inspectionTaskAssets||{};m[h]=s,await se(c,{inspectionTaskAssets:m}),$=s,H(),await V(),alert(`Successfully added ${s.length} asset(s) to this inspection task.`)}catch(n){console.error("Error saving selected assets:",n),alert("Failed to save selected assets. Please try again.")}}G&&G.addEventListener("click",de);K&&K.addEventListener("click",H);X&&X.addEventListener("click",H);Z&&Z.addEventListener("click",re);k&&k.addEventListener("click",n=>{n.target===k&&H()});async function me(n,s){w&&(R=n,s?(S&&(S.value=s.notes||""),s.solved==="yes"?document.getElementById("solved-yes").checked=!0:document.getElementById("solved-no").checked=!0):N&&N.reset(),w.classList.add("open"))}function U(){w&&(w.classList.remove("open"),N&&N.reset(),R=null)}async function pe(){var n,s;if(!(!v||h===null||!R))try{const c=((n=S==null?void 0:S.value)==null?void 0:n.trim())||"",e=((s=document.querySelector('input[name="solved"]:checked'))==null?void 0:s.value)||"";if(!c){alert("Please enter inspection notes.");return}if(!e){alert("Please select if the issue is solved or not.");return}const d=B(A,"maintenance",v),m=await M(d);if(!m.exists()){alert("Maintenance item not found.");return}const u=m.data().inspectionData||{};u[h]||(u[h]={}),u[h][R]={notes:c,solved:e,timestamp:new Date().toISOString(),updatedAt:new Date().toISOString()},await se(d,{inspectionData:u}),U(),await V(),alert("Inspection saved successfully.")}catch(c){console.error("Error saving inspection:",c),alert("Failed to save inspection. Please try again.")}}ee&&ee.addEventListener("click",U);te&&te.addEventListener("click",U);N&&N.addEventListener("submit",async n=>{n.preventDefault(),b&&(b.disabled=!0,b.textContent="Saving..."),await pe(),b&&(b.disabled=!1,b.textContent="Save Inspection")});w&&w.addEventListener("click",n=>{n.target===w&&U()});
