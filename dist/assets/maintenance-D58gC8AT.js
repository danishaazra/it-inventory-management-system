const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/firebase-firestore-BFWK-5cG.js","assets/firebase-app-D-fiV83C.js","assets/firebase-vendor-B2UDLW_X.js","assets/vendor-BdN5Q6dY.js","assets/firebase-auth-CnPx9bWP.js"])))=>i.map(i=>d[i]);
import{_ as V}from"./qrcode-DEXsfuzH.js";import{H as D,K as G,N as j,J as P}from"./firebase-vendor-B2UDLW_X.js";import{onAuthStateChanged as X}from"./firebase-auth-CnPx9bWP.js";import"./firebase-app-D-fiV83C.js";import{getDoc as Z,doc as ee,query as te,collection as O,limit as ne,getDocs as ae,addDoc as K}from"./firebase-firestore-BFWK-5cG.js";import{r as Q,u as B}from"./xlsx-vendor-DLNWaC59.js";import"./vendor-BdN5Q6dY.js";(async()=>{try{const{enableIndexedDbPersistence:n}=await V(async()=>{const{enableIndexedDbPersistence:e}=await import("./firebase-firestore-BFWK-5cG.js");return{enableIndexedDbPersistence:e}},__vite__mapDeps([0,1,2,3,4]));await n(D),console.log("Firestore persistence enabled")}catch(n){n.code!=="failed-precondition"&&n.code!=="unimplemented"&&console.warn("Persistence setup failed:",n.message)}})();const F=document.getElementById("user-name"),q=document.getElementById("user-avatar"),$=document.getElementById("maintenance-table-body"),S=document.getElementById("add-maintenance-btn"),oe=document.getElementById("add-maintenance-menu"),N=document.getElementById("maintenance-file-input"),M=document.getElementById("add-modal-overlay"),W=document.getElementById("close-add-modal-btn"),Y=document.getElementById("cancel-add-btn"),x=document.getElementById("add-maintenance-form"),A=document.getElementById("save-add-btn"),R=document.getElementById("add-frequency"),L=document.getElementById("add-schedule-container"),T=document.getElementById("add-schedule-calendar");let J=null;X(P,async n=>{if(!n){J=null;return}J||(J=G(j,"us-central1"),console.log("Functions instance initialized for user:",n.uid));try{let e=n.email||"User";const a=await Z(ee(D,"users",n.uid));if(a.exists()){const h=a.data();e=h.fullName||h.name||n.email||"User"}if(F&&(F.textContent=e),q){const h=e.trim().charAt(0).toUpperCase();q.textContent=h||"U"}}catch(e){console.error("Error loading user data for header:",e);const a=n&&(n.displayName||n.email)||"User";if(F&&(F.textContent=a),q){const h=a.trim().charAt(0).toUpperCase();q.textContent=h||"U"}}try{await U()}catch(e){console.error("Error loading maintenance schedule:",e)}});function se(n){if(!n)return"";const e=n.toLowerCase();return e.includes("weekly")?"frequency-weekly":e.includes("monthly")?"frequency-monthly":e.includes("quarterly")?"frequency-quarterly":""}async function U(){if(console.log("Loading maintenance schedule..."),!$){console.error("maintenanceTableBody element not found!");return}$.innerHTML="";const n=document.createElement("tr"),e=document.createElement("td");e.colSpan=4,e.textContent="Loading...",e.style.textAlign="center",e.style.padding="2rem",e.style.color="#666",n.appendChild(e),$.appendChild(n);try{console.log("Fetching maintenance items from Firestore...");const a=performance.now(),h=te(O(D,"maintenance"),ne(1e3)),y=await ae(h),p=performance.now()-a;if(console.log(`Maintenance items fetched: ${y.size} in ${p.toFixed(2)}ms`),$.innerHTML="",y.empty){const f=document.createElement("tr"),o=document.createElement("td");o.colSpan=5,o.textContent='No maintenance items found. Click "Add Maintenance" to add one.',o.style.color="#666",o.style.textAlign="center",o.style.padding="2rem",f.appendChild(o),$.appendChild(f);return}y.forEach(f=>{const o=f.data(),E=o.inspectionTasks||"",l=Array.isArray(E)?E:typeof E=="string"?E.split(`
`).filter(C=>C.trim()):[];console.log("Processing maintenance item:",f.id,o);const t=document.createElement("tr"),g=se(o.frequency),u=document.createElement("td");u.textContent=o.branch||"",t.appendChild(u);const s=document.createElement("td");s.textContent=o.location||"",t.appendChild(s);const c=document.createElement("td");c.textContent=o.itemName||"",t.appendChild(c);const d=document.createElement("td"),v=document.createElement("span");v.className=`frequency-badge ${g}`,v.textContent=o.frequency||"",d.appendChild(v),t.appendChild(d);const r=document.createElement("td"),m=document.createElement("a");m.href=`/inspection/inspectiontask.html?id=${encodeURIComponent(f.id)}`,m.className="inspection-tasks-link",m.textContent=`View Tasks (${l.length})`,r.appendChild(m),t.appendChild(r),$.appendChild(t)}),console.log("Maintenance schedule loaded successfully")}catch(a){console.error("Error loading maintenance schedule:",a),$.innerHTML="";const h=document.createElement("tr"),y=document.createElement("td");y.colSpan=5,y.textContent=`Failed to load maintenance schedule: ${a.message}. Please refresh.`,y.style.color="#b91c1c",y.style.textAlign="center",y.style.padding="2rem",h.appendChild(y),$.appendChild(h)}}function ce(n,e){!n||!e||(n.addEventListener("click",a=>{a.stopPropagation(),e.classList.toggle("open")}),e.addEventListener("click",a=>{const h=a.target.closest("button[data-action]");if(!h)return;const y=h.getAttribute("data-action");y==="manual"?le():y==="upload"&&N&&N.click(),e.classList.remove("open")}),document.addEventListener("click",()=>{e.classList.remove("open")}))}ce(S,oe);function z(n,e,a={}){e.innerHTML="";const h=new Date().getFullYear(),y=document.createElement("select");y.className="calendar-year-select";for(let E=h;E<=h+2;E++){const l=document.createElement("option");l.value=E,l.textContent=E,E===h&&(l.selected=!0),y.appendChild(l)}const p=document.createElement("div");p.className="calendar-year-selector";const f=document.createElement("label");f.textContent="Year: ",f.style.fontWeight="600",p.appendChild(f),p.appendChild(y),e.appendChild(p);const o=document.createElement("div");o.className="calendar-months",n==="Weekly"?["January","February","March","April","May","June","July","August","September","October","November","December"].forEach((l,t)=>{const g=document.createElement("div");g.className="calendar-month";const u=document.createElement("div");u.className="calendar-month-header",u.textContent=l,g.appendChild(u);const s=document.createElement("div");s.className="calendar-weeks";for(let c=1;c<=4;c++){const d=document.createElement("div");d.className="calendar-week";const v=document.createElement("div");v.className="calendar-week-label",v.textContent=`Week ${c}:`,d.appendChild(v);const r=document.createElement("input");r.type="date",r.className="calendar-date-input",r.dataset.month=t,r.dataset.week=c,r.dataset.key=`${t}-${c}`;const m=parseInt(y.value),C=new Date(m,t,1).getDay(),b=C===0?2:C===1?1:9-C,i=new Date(m,t,b+(c-1)*7);i.getMonth()===t&&(r.value=i.toISOString().split("T")[0]);const k=`${m}-${t}-${c}`;a[k]&&(r.value=a[k]),d.appendChild(r),s.appendChild(d)}g.appendChild(s),o.appendChild(g)}):n==="Monthly"?["January","February","March","April","May","June","July","August","September","October","November","December"].forEach((l,t)=>{const g=document.createElement("div");g.className="calendar-month";const u=document.createElement("div");u.className="calendar-month-header",u.textContent=l,g.appendChild(u);const s=document.createElement("input");s.type="date",s.className="calendar-date-input",s.dataset.month=t,s.dataset.key=`${t}`;const c=parseInt(y.value),d=new Date(c,t,1);s.value=d.toISOString().split("T")[0];const v=`${c}-${t}`;a[v]&&(s.value=a[v]),g.appendChild(s),o.appendChild(g)}):n==="Quarterly"&&[{name:"Q1",months:["January","February","March"],monthIndices:[0,1,2]},{name:"Q2",months:["April","May","June"],monthIndices:[3,4,5]},{name:"Q3",months:["July","August","September"],monthIndices:[6,7,8]},{name:"Q4",months:["October","November","December"],monthIndices:[9,10,11]}].forEach((l,t)=>{const g=document.createElement("div");g.className="calendar-quarter";const u=document.createElement("div");u.className="calendar-quarter-label",u.textContent=l.name,g.appendChild(u);const s=document.createElement("div");s.style.display="flex",s.style.alignItems="center",s.style.gap="0.5rem",s.style.marginBottom="0.5rem";const c=document.createElement("label");c.textContent="Select Month:",c.style.minWidth="100px",c.style.fontSize="0.85rem",c.style.fontWeight="600",s.appendChild(c);const d=document.createElement("select");d.className="calendar-month-select",d.dataset.quarter=t,d.dataset.key=`${t}`;const v=document.createElement("option");v.value="",v.textContent="Choose month...",d.appendChild(v),l.months.forEach((b,i)=>{const k=l.monthIndices[i],w=document.createElement("option");w.value=k,w.textContent=b,d.appendChild(w)});const r=parseInt(y.value);let m=null;for(let b=0;b<l.months.length;b++){const i=l.monthIndices[b],k=`${r}-${t}-${b}`;if(a[k]){m=i,d.value=i;break}}s.appendChild(d);const C=document.createElement("input");if(C.type="date",C.className="calendar-date-input",C.dataset.quarter=t,C.dataset.key=`${t}`,C.style.display=m!==null?"block":"none",C.style.marginTop="0.5rem",m!==null){for(let b=0;b<l.months.length;b++)if(l.monthIndices[b]===m){const k=`${r}-${t}-${b}`;if(a[k])C.value=a[k];else{const w=new Date(r,m,1);C.value=w.toISOString().split("T")[0]}break}}d.addEventListener("change",()=>{if(d.value){const b=parseInt(d.value);C.style.display="block";const i=new Date(r,b,1);C.value=i.toISOString().split("T")[0];for(let k=0;k<l.months.length;k++)if(l.monthIndices[k]===b){const w=`${r}-${t}-${k}`;a[w]&&(C.value=a[w]);break}}else C.style.display="none",C.value=""}),g.appendChild(s),g.appendChild(C),o.appendChild(g)}),e.appendChild(o),y.addEventListener("change",()=>{z(n,e,a)})}function re(n,e,a){const h={};return n.querySelectorAll(".calendar-date-input").forEach(p=>{if(p.value&&p.style.display!=="none"){const f=p.dataset.key;if(e==="Weekly"){const[o,E]=f.split("-");h[`${a}-${o}-${E}`]=p.value}else if(e==="Monthly"){const o=f;h[`${a}-${o}`]=p.value}else if(e==="Quarterly"){const o=parseInt(f),E=n.querySelector(`select[data-quarter="${o}"]`);if(E&&E.value){const l=parseInt(E.value),u=[{monthIndices:[0,1,2]},{monthIndices:[3,4,5]},{monthIndices:[6,7,8]},{monthIndices:[9,10,11]}][o].monthIndices.indexOf(l);u!==-1&&(h[`${a}-${o}-${u}`]=p.value)}}}}),h}R&&L&&T&&R.addEventListener("change",n=>{const e=n.target.value;e?(L.style.display="block",z(e,T)):(L.style.display="none",T.innerHTML="")});function le(){M&&(x&&x.reset(),M.classList.add("open"))}function _(){M&&(M.classList.remove("open"),x&&x.reset(),L&&(L.style.display="none"),T&&(T.innerHTML=""))}W&&W.addEventListener("click",_);Y&&Y.addEventListener("click",_);M&&M.addEventListener("click",n=>{n.target===M&&_()});x&&x.addEventListener("submit",async n=>{var e,a,h,y,p;if(n.preventDefault(),!!A){A.disabled=!0,A.textContent="Adding...";try{const f=new FormData(x),o=((e=f.get("location"))==null?void 0:e.trim())||"";if(!o){alert("Location is required."),A.disabled=!1,A.textContent="Add Maintenance";return}const l=(((a=f.get("inspectionTasks"))==null?void 0:a.trim())||"").split(`
`).map(d=>d.trim()).filter(d=>d.length>0),t=f.get("frequency")||"",g=((h=T==null?void 0:T.querySelector(".calendar-year-select"))==null?void 0:h.value)||new Date().getFullYear(),u=re(T,t,parseInt(g)),s=[];t==="Weekly"?l.forEach((d,v)=>{for(let r=0;r<12;r++){for(let m=1;m<=4;m++){const C=`${g}-${r}-${m}`;if(u[C]){s[v]=u[C];break}}if(s[v])break}}):t==="Monthly"?l.forEach((d,v)=>{const r=v%12,m=`${g}-${r}`;s[v]=u[m]||""}):t==="Quarterly"&&l.forEach((d,v)=>{const r=Math.floor(v/3),m=v%3,C=`${g}-${r}-${m}`;s[v]=u[C]||""});const c={branch:((y=f.get("branch"))==null?void 0:y.trim())||"",location:o,itemName:((p=f.get("itemName"))==null?void 0:p.trim())||"",frequency:t,inspectionTasks:l,scheduleDates:u,scheduleYear:parseInt(g),taskDates:s,createdAt:new Date().toISOString()};await K(O(D,"maintenance"),c),alert("Maintenance item added successfully!"),_(),await U()}catch(f){console.error("Error adding maintenance item:",f),alert("Failed to add maintenance item. Please try again.")}finally{A&&(A.disabled=!1,A.textContent="Add Maintenance")}}});N&&N.addEventListener("change",async n=>{var y;const e=n.target.files[0];if(!e)return;const a=P.currentUser;if(!a){alert("You must be logged in to upload files. Please log in and try again."),N.value="";return}const h=(S==null?void 0:S.textContent)||"";S&&(S.disabled=!0,S.innerHTML="<span>‚è≥</span> <span>Processing with AI...</span>");try{const p=await e.arrayBuffer(),f=Q(p,{type:"array",cellStyles:!0}),o=f.SheetNames[0],E=f.Sheets[o],l=[],t=B.decode_range(E["!ref"]||"A1");for(let i=t.s.r;i<=t.e.r;i++)for(let k=t.s.c;k<=t.e.c;k++){const w=B.encode_cell({r:i,c:k}),I=E[w];l.push({address:w,row:i+1,col:k+1,value:I&&I.v!==void 0?String(I.v):"",type:I&&I.t||"s",formatted:I?I.w||String(I.v||""):""})}const g=E["!merges"]||[],u=[],s=t.e.r+1,c=t.e.c+1;for(let i=0;i<s;i++){const k=[];for(let w=0;w<c;w++){const I=B.encode_cell({r:i,c:w}),H=E[I];k.push(H?H.w||String(H.v||""):"")}u.push(k)}if(!u||u.length===0){alert("The file appears to be empty.");return}const d=await a.getIdToken();if(!d)throw new Error("Failed to get authentication token");const v=`https://us-central1-${j.options.projectId}.cloudfunctions.net/extractMaintenanceChecklist`,r=await fetch(v,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${d}`},body:JSON.stringify({excelRows:u,cellData:l,mergedCells:g.map(i=>({s:{r:i.s.r,c:i.s.c},e:{r:i.e.r,c:i.e.c}})),sheetName:o})});if(!r.ok){const i=await r.text();throw new Error(`Function call failed: ${r.status} ${r.statusText} - ${i}`)}const m=await r.json();if(!m.success||!m.items||m.items.length===0){alert("AI could not extract maintenance data from the file. Please check the file format.");return}const C=O(D,"maintenance"),b=m.items.map(i=>{const k={branch:i.branch||"",location:i.location||"",itemName:i.itemName||"",frequency:i.frequency||"Monthly",inspectionTasks:i.inspectionTasks||[],sourceFile:e.name,parsedByAI:!0,createdAt:new Date().toISOString()};return K(C,k)});await Promise.all(b),alert(`Successfully processed and uploaded ${b.length} maintenance items using AI!`),await U()}catch(p){if(console.error("Error importing maintenance file:",p),console.error("Error details:",{code:p.code,message:p.message,currentUser:a?a.uid:"null",hasAuth:!!a,authCurrentUser:P.currentUser?P.currentUser.uid:"null"}),p.code==="functions/unavailable"||p.code==="functions/not-found")alert("AI service is currently unavailable. Please ensure the Cloud Function is deployed.");else if(p.code==="functions/unauthenticated"||(y=p.message)!=null&&y.includes("authenticated"))alert("Authentication error. Please log out and log back in, then try again.");else if(p.message&&p.message.includes("AI")){alert("AI parsing failed. Trying manual parsing...");try{const f=await e.arrayBuffer(),o=Q(f,{type:"array"}),E=o.SheetNames[0],l=o.Sheets[E],t=B.sheet_to_json(l,{header:1,defval:""});if(!t||t.length<=1){alert("The file appears to be empty or missing data rows.");return}const g=t.slice(1),u=O(D,"maintenance"),s=g.filter(c=>c&&c.length>0&&String(c[0]||"").trim()!=="").map(c=>{const v=String(c[4]??"").trim().split(`
`).map(m=>m.trim()).filter(m=>m.length>0),r={branch:String(c[0]??"").trim(),location:String(c[1]??"").trim(),itemName:String(c[2]??"").trim(),frequency:String(c[3]??"").trim(),inspectionTasks:v,sourceFile:e.name,parsedByAI:!1,createdAt:new Date().toISOString()};return K(u,r)});if(s.length===0){alert("No valid data rows found in the file.");return}await Promise.all(s),alert(`Successfully uploaded ${s.length} maintenance items (manual parsing).`),await U()}catch(f){console.error("Fallback parsing also failed:",f),alert("Failed to import file. Please check the format and try again.")}}else alert("Failed to import file: "+(p.message||"Unknown error"))}finally{N.value="",S&&(S.disabled=!1,S.innerHTML=h)}});
